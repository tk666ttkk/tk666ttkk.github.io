<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Redis集群 | Hxtk_blog</title><meta name="author" content="Hxtk"><meta name="copyright" content="Hxtk"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="Redis集群">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis集群">
<meta property="og:url" content="https://tk666ttkk.github.io/2023/10/21/Redis%E9%9B%86%E7%BE%A4/index.html">
<meta property="og:site_name" content="Hxtk_blog">
<meta property="og:description" content="Redis集群">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://tk666ttkk.github.io/img/rediscluster.png">
<meta property="article:published_time" content="2023-10-21T09:59:22.000Z">
<meta property="article:modified_time" content="2023-10-21T09:59:29.000Z">
<meta property="article:author" content="Hxtk">
<meta property="article:tag" content="Redis集群">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tk666ttkk.github.io/img/rediscluster.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://tk666ttkk.github.io/2023/10/21/Redis%E9%9B%86%E7%BE%A4/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":true,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":100,"languages":{"author":"作者: Hxtk","link":"链接: ","source":"来源: Hxtk_blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Redis集群',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-10-21 17:59:29'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-artitalk-pro/lib/card.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (false) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">8</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 目录</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 资源</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url('/img/rediscluster.png')"><nav id="nav"><span id="blog-info"><a href="/" title="Hxtk_blog"><span class="site-name">Hxtk_blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 目录</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 资源</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Redis集群</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-10-21T09:59:22.000Z" title="发表于 2023-10-21 17:59:22">2023-10-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-10-21T09:59:29.000Z" title="更新于 2023-10-21 17:59:29">2023-10-21</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Redis%E9%9B%86%E7%BE%A4/">Redis集群</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">1.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>7分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Redis集群"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Redis分布式集群企业开发实战"><a href="#Redis分布式集群企业开发实战" class="headerlink" title="Redis分布式集群企业开发实战"></a>Redis分布式集群企业开发实战</h1><p>REDIS 集群结合微服务实战：(分为本地开发环境和实际生产环境)</p>
<h2 id="本地开发环境"><a href="#本地开发环境" class="headerlink" title="本地开发环境"></a>本地开发环境</h2><p>1创建实例文件</p>
<p>mkdir 7001 7002 7003<br>2拷贝配置文件</p>
<p>cp redis.conf 7001<br>3修改配置文件</p>
<p>sed -i -e ‘s&#x2F;6379&#x2F;7004&#x2F;g’ -e ‘s&#x2F;dir ./&#x2F;dir /tmp/7004/&#x2F;g’ 7004&#x2F;redis.conf<br>sed -i -e ‘s&#x2F;6379&#x2F;7005&#x2F;g’ -e ‘s&#x2F;dir ./&#x2F;dir /tmp/7005/&#x2F;g’ 7005&#x2F;redis.conf<br>sed -i -e ‘s&#x2F;6379&#x2F;7006&#x2F;g’ -e ‘s&#x2F;dir ./&#x2F;dir /tmp/7006/&#x2F;g’ 7006&#x2F;redis.conf</p>
<p>sed -i -e ‘s&#x2F;192.168.150.101&#x2F;192.168.101.65&#x2F;g’ 7001&#x2F;redis.conf<br>sed -i -e ‘s&#x2F;192.168.150.101&#x2F;192.168.101.65&#x2F;g’ 7002&#x2F;redis.conf</p>
<p>sed -i -e ‘s&#x2F;192.168.150.101&#x2F;192.168.101.65&#x2F;g’ 7003&#x2F;redis.conf</p>
<p>sed -i -e ‘s&#x2F;192.168.150.101&#x2F;192.168.101.65&#x2F;g’ 7004&#x2F;redis.conf</p>
<p>sed -i -e ‘s&#x2F;192.168.150.101&#x2F;192.168.101.65&#x2F;g’ 7005&#x2F;redis.conf</p>
<p>4声明实例属于哪个ip地址端口，在每个文件的第一行声明</p>
<p>sed -i ‘1a replica-announce-ip 192.168.101.65’ 7001&#x2F;redis.conf<br>sed -i ‘1a replica-announce-ip 192.168.101.65’ 7002&#x2F;redis.conf<br>sed -i ‘1a replica-announce-ip 192.168.101.65’ 7003&#x2F;redis.conf</p>
<p>sed -i ‘1a replica-announce-ip 47.113.207.230’ 7004&#x2F;redis.conf</p>
<p>sed -i ‘1a replica-announce-ip 47.113.207.230’ 7005&#x2F;redis.conf</p>
<p>sed -i ‘1a replica-announce-ip 47.113.207.230’ 7006&#x2F;redis.conf</p>
<p>5利用配置文件启动一个不存在的redis实例</p>
<p>创建集群实例</p>
<p>docker run -d –name redis-7006 –net host –privileged&#x3D;true  -v &#x2F;app&#x2F;redis&#x2F;7006:&#x2F;data redis:6.2.7 –cluster-enabled yes –appendonly yes –port 7006</p>
<p>创建普通实例</p>
<p>docker run  -p 6379:6379  –name redis –privileged&#x3D;true -v &#x2F;app&#x2F;redis&#x2F;redis.conf:&#x2F;etc&#x2F;redis&#x2F;redis.conf -v &#x2F;app&#x2F;redis&#x2F;data:&#x2F;data -d redis:6.2.7 redis-server &#x2F;etc&#x2F;redis&#x2F;redis.conf</p>
<p>6集群</p>
<p>进入某个redis实例容器中</p>
<p>docker exec -it redis-7001 &#x2F;bin&#x2F;bash</p>
<p>创建集群</p>
<p>redis-cli –cluster create 118.126.92.19:7001 118.126.92.19:7002 118.126.92.19:7003 118.126.92.19:7004 118.126.92.19:7005 118.126.92.19:7006  –cluster-replicas 1 </p>
<p>redis-cli –cluster create 47.113.207.230:7001 47.113.207.230:7002 47.113.207.230:7003  –cluster-replicas 1 </p>
<p>安装完毕：</p>
<p>1.在容器中启动一个已经存在的redis实例</p>
<p>docker start redis-7001</p>
<p>2.进入某个节点实例</p>
<p>docker exec -it redis-7001 &#x2F;bin&#x2F;bash</p>
<p>3.集群模式下的单个实例</p>
<p>redis-cli -c -p 7001 </p>
<p>每个主从都有固定的hash slot，0-5643等分，不同数据存储到不同实例的slot中</p>
<p>3.集群信息和集群中节点的主从信息</p>
<p>cluster info cluster nodes</p>
<p>4.主从集群具体分布，你开启主从集群的时候一般是按照特定顺序分配主从关系的</p>
<p>M -&gt; S</p>
<p>1 -&gt;6 ; </p>
<p>2 -&gt; 4;</p>
<p>3 -&gt; 5</p>
<p>5集群检查</p>
<p>redis-cli –cluster check 192.168.101.65:7001 </p>
<p>6.故障转移</p>
<p>docker stop redis-7001,7006会自动切换为master,当restart 7001，则7001会自动slave of 7006,此时还能正常读取数据；</p>
<p>7.主从恢复</p>
<p>要想恢复只能停掉当前的master,让slave有上位的机会。再启动之前停掉的master就会变成slave。</p>
<p>8.集群扩缩容</p>
<p>9.jmeter</p>
<p>1w异常率，10w并发	</p>
<p>10.分布式缓存实战：</p>
<p>项目中使用redis分布式集群，1.nacos修改redis配置，连接其中一个节点会自动连接其他节点2.java客户端编写redis-cluster.conf.yml配置文件3.redis虚拟机开启集群实例，</p>
<p>当您在一个节点上设置缓存时，Redis会自动将数据复制到其他节点，以确保高可用性和数据一致性。(这样一个节点挂了还有五个节点存有相同的数据)，当其中的一个节点删除数据，集群中的其他节点也会删除数据</p>
<p>Redis集群的主要优势是提供高可用性和负载均衡,但是会带来额外的内存开销，如果希望减少内存的多次复制，可以考虑分区，将不同内容存储到不同节点，但是这也会导致高可用和一致性受损。</p>
<p>需要二者比较而考虑，重要的数据尽量备份多份不分区，某些数据可以考虑分区存储。</p>
<p>11.实战测试样例，jmeter</p>
<p>![](&#x2F;img&#x2F;old 10w.png)</p>
<p><img src="/img/11cluster10w.png"></p>
<p><img src="/img/cluster%E7%BC%93%E5%AD%98.png"></p>
<p><img src="/img/%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8%E6%83%85%E5%86%B5.png"></p>
<p><img src="/img/cluster100w%E5%B9%B6%E5%8F%91.png"></p>
<p>12.stop 7001,delete 缓存，10w并发</p>
<p>7006充当新master,在7001重启期间数据读取正常,7001重启后变为slave,要想成为master只能主动stop 7006,再start 7006,不过实战一般不推荐这么做，会带来风险。</p>
<p>docker stop redis-7001 &#x2F;&#x2F;模拟一个redis节点实例宕机的情况</p>
<p>docker start redis-7001 &#x2F;&#x2F;假设运维人员修复了该节点</p>
<p>docker exec -it redis-7001 &#x2F;bin&#x2F;bash</p>
<p>redis-cli -c - p 7001 </p>
<p>CLUSTER FAILOVER &#x2F;&#x2F;进入当前slave节点手动进行主从切换</p>
<p>​	</p>
<p><img src="/img/%E5%81%9C%E6%8E%897001,delete%E7%BC%93%E5%AD%98,10w%E5%B9%B6%E5%8F%91.png"></p>
<p><img src="/img/java%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E4%B8%BB%E4%BB%8E%E5%88%87%E6%8D%A2.png"></p>
<h2 id="实际生产环境"><a href="#实际生产环境" class="headerlink" title="实际生产环境"></a>实际生产环境</h2><h3 id="在我的云服务器上新建redis集群，并连接"><a href="#在我的云服务器上新建redis集群，并连接" class="headerlink" title="在我的云服务器上新建redis集群，并连接"></a>在我的云服务器上新建redis集群，并连接</h3><p>10.9开始测试我的服务器启动docker<br>两个docker管理相同的内容，这个内容指的是相同的缓存，就是两个docker开启不同的实例，有各自的节点，和主从结构，最后通过分区管理不同的数据，</p>
<p>版本信息</p>
<p>root@VM-12-6-ubuntu:&#x2F;etc&#x2F;docker# lsb_release -a<br>No LSB modules are available.<br>Distributor ID:	Ubuntu<br>Description:	Ubuntu 22.04.2 LTS<br>Release:	22.04<br>Codename:	jammy<br>root@VM-12-6-ubuntu:&#x2F;etc&#x2F;docker# </p>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/install/ubuntu/">https://docs.docker.com/engine/install/ubuntu/</a></p>
<p><a target="_blank" rel="noopener" href="https://hub.docker.com/">https://hub.docker.com/</a></p>
<p>1.修改镜像</p>
<p>sudo cp &#x2F;etc&#x2F;apt&#x2F;sources.list &#x2F;etc&#x2F;apt&#x2F;sources.list.bak</p>
<p>sudo nano &#x2F;etc&#x2F;apt&#x2F;sources.list</p>
<p>deb <a target="_blank" rel="noopener" href="http://mirrors.aliyun.com/ubuntu/">http://mirrors.aliyun.com/ubuntu/</a> jammy main restricted universe multiverse<br>deb-src <a target="_blank" rel="noopener" href="http://mirrors.aliyun.com/ubuntu/">http://mirrors.aliyun.com/ubuntu/</a> jammy main restricted universe multiverse</p>
<p>deb <a target="_blank" rel="noopener" href="http://mirrors.aliyun.com/ubuntu/">http://mirrors.aliyun.com/ubuntu/</a> jammy-security main restricted universe multiverse<br>deb-src <a target="_blank" rel="noopener" href="http://mirrors.aliyun.com/ubuntu/">http://mirrors.aliyun.com/ubuntu/</a> jammy-security main restricted universe multiverse</p>
<p>deb <a target="_blank" rel="noopener" href="http://mirrors.aliyun.com/ubuntu/">http://mirrors.aliyun.com/ubuntu/</a> jammy-updates main restricted universe multiverse<br>deb-src <a target="_blank" rel="noopener" href="http://mirrors.aliyun.com/ubuntu/">http://mirrors.aliyun.com/ubuntu/</a> jammy-updates main restricted universe multiverse</p>
<p>2.具体安装步骤</p>
<p>以下三步是配置文件和官方配置</p>
<p>sudo apt install -y apt-transport-https ca-certificates curl software-properties-common</p>
<p>curl -fsSL <a target="_blank" rel="noopener" href="https://download.docker.com/linux/ubuntu/gpg">https://download.docker.com/linux/ubuntu/gpg</a> | sudo gpg –dearmor -o &#x2F;usr&#x2F;share&#x2F;keyrings&#x2F;docker-archive-keyring.gpg</p>
<p>echo “deb [arch&#x3D;amd64 signed-by&#x3D;&#x2F;usr&#x2F;share&#x2F;keyrings&#x2F;docker-archive-keyring.gpg] <a target="_blank" rel="noopener" href="https://download.docker.com/linux/ubuntu">https://download.docker.com/linux/ubuntu</a> $(lsb_release -cs) stable” | sudo tee &#x2F;etc&#x2F;apt&#x2F;sources.list.d&#x2F;docker.list &gt; &#x2F;dev&#x2F;null</p>
<p>安装</p>
<p>sudo apt-get update<br>sudo apt-get install docker.io</p>
<p>彻底删除</p>
<p>sudo apt-get remove docker docker-engine docker.io containerd runc</p>
<p>2.配置ali镜像</p>
<p><a target="_blank" rel="noopener" href="https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors">https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors</a></p>
<p>sudo mkdir -p &#x2F;etc&#x2F;docker </p>
<p>sudo tee &#x2F;etc&#x2F;docker&#x2F;daemon.json &lt;&lt;-‘EOF’ {  “registry-mirrors”: [“<a target="_blank" rel="noopener" href="https://hhjblu41.mirror.aliyuncs.com"]">https://hhjblu41.mirror.aliyuncs.com&quot;]</a> } EOF </p>
<p>3.重启配置</p>
<p>sudo systemctl daemon-reload<br>sudo systemctl restart docker</p>
<p>4验证是否安装成功</p>
<p>docker –version</p>
<p>dokcer run hello-world</p>
<p>5.docker安装软件</p>
<p>安装redis</p>
<p>sudo find &#x2F; -type f -name redis-server —&gt; 查找redis的位置 &#x2F;root&#x2F;redis-6.2.7</p>
<p>sudo apt update</p>
<p>sudo apt install -y build-essential tcl</p>
<p>wget <a target="_blank" rel="noopener" href="http://download.redis.io/releases/redis-6.2.7.tar.gz">http://download.redis.io/releases/redis-6.2.7.tar.gz</a><br>tar xzf redis-6.2.7.tar.gz</p>
<p>cd redis-6.2.7</p>
<p>make<br>sudo make install</p>
<p>redis-server –version</p>
<p>redis-server</p>
<p>redis安装目录(和docker中容器中的redis是不一样的)：118: &#x2F;data&#x2F;redis-6.2.7   47: &#x2F;root&#x2F;redis-6.2.7  都是通过&#x2F;app&#x2F;redis的方式进行挂载的</p>
<p>将redis加入docker容器</p>
<p>docker pull redis</p>
<p>docker ps</p>
<p>docker exec -it my-redis redis-cli</p>
<p>docker stop my-redis<br>docker rm my-redis</p>
<p>将redis加入docker容器（data&#x2F;redis data&#x2F;nginx 。。是软件下载的目录 ，但是&#x2F;app&#x2F;redis &#x2F;app&#x2F;nginx 是宿主机挂载到docker容器的目录，修改此处即修改docker中的相应的配置文件）</p>
<p>mkdir -p &#x2F;app&#x2F;redis</p>
<p>cp &#x2F;data&#x2F;redis-6.2.7&#x2F;redis.conf &#x2F;app&#x2F;redis&#x2F;</p>
<p>cp &#x2F;root&#x2F;redis-6.2.7&#x2F;redis.conf &#x2F;app&#x2F;redis&#x2F;</p>
<p>将配置文件挂载到dokcer容器中</p>
<p>docker run  -p 6379:6379  –name redis –privileged&#x3D;true -v &#x2F;app&#x2F;redis&#x2F;redis.conf:&#x2F;etc&#x2F;redis&#x2F;redis.conf -v &#x2F;app&#x2F;redis&#x2F;data:&#x2F;data -d redis:6.2.7 redis-server &#x2F;etc&#x2F;redis&#x2F;redis.conf</p>
<p>5.云服务器记得开放端口</p>
<p>6两个集群的redis节点进行连接</p>
<p>挂载文件的位置弄了好几天了，原来就是挂载到当前目录下面，真服了，搞得我一度抑郁了2天，</p>
<p>slot的问题也弄了一天半(最后要通过网络连接，再meet将两个集群连接起来)</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis-1:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-7001</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">/etc/redis/redis.conf</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./7001/redis.conf:/etc/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./7001/data:/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7001</span><span class="string">:7001</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17001</span><span class="string">:17001</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-network</span>  <span class="comment"># 连接到名为redis-network的自定义网络</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis-2:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-7002</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">/etc/redis/redis.conf</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./7002/redis.conf:/etc/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./7002/data:/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7002</span><span class="string">:7002</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17002</span><span class="string">:17002</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-network</span>  <span class="comment"># 连接到名为redis-network的自定义网络</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis-3:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-7003</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">/etc/redis/redis.conf</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./7003/redis.conf:/etc/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./7003/data:/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7003</span><span class="string">:7003</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17003</span><span class="string">:17003</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-network</span>  <span class="comment"># 连接到名为redis-network的自定义网络</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">redis-network:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure>



<p>redis.conf(bind 单节点实例)</p>
<p>daemonize no<br>dir &#x2F;data&#x2F;<br>dbfilename dump.rdb<br>rdbcompression yes<br>rdbchecksum yes<br>save 10 2<br>appendonly yes<br>appendfsync always<br>appendfilename appendonly.aof<br>databases 16<br>port 7001<br>protected-mode no<br>client-output-buffer-limit slave 0 0 0<br>cluster-enabled yes<br>cluster-config-file nodes.conf<br>cluster-node-timeout 10000<br>cluster-announce-ip 172.26.83.183(公网ip)<br>cluster-announce-port 7001<br>cluster-announce-bus-port 17001</p>
<p>重装dokcr：</p>
<p>sudo apt-get update<br>sudo apt-get upgrade docker.io</p>
<p>pip install –upgrade docker</p>
<p>sudo systemctl restart docker</p>
<p>启动docker-compose</p>
<p>docker-compose -f ms1.yml up -d</p>
<p>每个云服务器三台节点，共6个组成集群，只有这6个成为一个集群，他们之间才能互相通信</p>
<p>全部删除</p>
<p>1.全部7001-7003删除，删docker节点</p>
<p>2.删docker-compose  </p>
<p>sudo apt-get install -y docker-compose</p>
<p>sudo apt-get remove docker-compose</p>
<p>3.创建7001-7003，只含redis.conf</p>
<p>4.运行yml(network)</p>
<p>4.cd &#x2F;etc(宿主机下，在挂载到容器内的实例)</p>
<p>vim &#x2F;etc&#x2F;sysctl.conf </p>
<p>vm.overcommit_memory &#x3D; 1</p>
<p>sudo sysctl -p &#x2F;etc&#x2F;sysctl.conf</p>
<p>docker cp &#x2F;etc&#x2F;sysctl.conf redis-7001:&#x2F;etc&#x2F;sysctl.conf<br>docker restart redis-7001</p>
<p>5创建集群</p>
<p>docker exec -it redis-7001 &#x2F;bin&#x2F;bash</p>
<p>redis-cli -c -h 118.126.92.19 -p 7001 -a “$(cat &#x2F;etc&#x2F;redis&#x2F;redis_password.txt)” </p>
<p>redis-cli -c -h 47.113.207.230 -p 7002 -a “$(cat &#x2F;etc&#x2F;redis&#x2F;redis_password.txt)” </p>
<p>redis-cli –cluster create 118.126.92.19:7001 118.126.92.19:7002  118.126.92.19:7003   47.113.207.230:7001 47.113.207.230:7002  47.113.207.230:7003  –cluster-replicas 1 –cluster-yes</p>
<p>5.5集群创建成功</p>
<p>  M     -     S</p>
<p>18:01 - 47:03 [0-5460] </p>
<p>18:02 - 47:02 [10923-16383]</p>
<p>47:01 - 18:03 [5461-10922]</p>
<p>6检查</p>
<p>cluster info &#x2F; nodes</p>
<p>redis-cli –cluster check 118.126.92.19:7001</p>
<p>redis-cli –cluster info 47.113.207.230:7001</p>
<p>docker ps</p>
<p>ps -aux | grep redis	</p>
<p>docker-compose -f ms1.yml logs</p>
<p>下面的修复选看</p>
<p>7修复(还差一个从节点没有分配进来，手动把他拉进来，)</p>
<p>首先连接两个集群，meet</p>
<p>118下</p>
<p>CLUSTER MEET 47.113.207.230 7001</p>
<p>47下</p>
<p>CLUSTER MEET 47.113.207.230 7001</p>
<p>在手动修复节点，采用随机分配的key</p>
<p>root@736d689e50b3:&#x2F;data# redis-cli –cluster fix 118.126.92.19:7001<br>118.126.92.19:7001 (eea90c75…) -&gt; 0 keys | 7818 slots | 0 slaves.<br>118.126.92.19:7002 (a799ae4a…) -&gt; 0 keys | 6440 slots | 0 slaves.<br>118.126.92.19:7003 (02017b47…) -&gt; 0 keys | 2126 slots | 0 slaves.<br>[OK] 0 keys in 3 masters.<br>0.00 keys per slot on average.</p>
<blockquote>
<blockquote>
<blockquote>
<p>928],[9930],[9932-94-8975],[874-6576],[6578-6580],[6583],[6585-6586],[6589-6590],[0897],[10900],[10903],[10905-10906],[10908],[10910],[10912-10914],[10916],[10919],[10921] (2126 slots) master<br>[OK] All nodes agree about slots configuration.<br>Check for open slots…<br>Check slots coverage…<br>[OK] All 16384 slots covered.<br>root@736d689e50b3:&#x2F;data#  </p>
</blockquote>
</blockquote>
</blockquote>
<p>细说集群关系：</p>
<p>47:03（无槽位） 18:01 18:02 18:03 4个master互联</p>
<p>47:02（无槽位） 18:01 18:02 18:03 4个master互联</p>
<p>slave: 47:01（无槽位 ）master: 18:01 18:02 18:03  </p>
<p>18:01 18:02 18:03  3个，master互相连接成立集群</p>
<p>8验证</p>
<p>118.126.92.19:7001&gt; set k1 v1<br>-&gt; Redirected to slot [12706] located at 118.126.92.19:7002<br>OK<br>118.126.92.19:7002&gt; </p>
<p>47.113.207.230:7001&gt; set k2 v2<br>-&gt; Redirected to slot [449] located at 118.126.92.19:7001<br>OK<br>118.126.92.19:7001&gt; </p>
<p>RESP上6个节点都有k1 k2。</p>
<p>9压力测试</p>
<p>redis-benchmark -h 118.126.92.19 -p 7001</p>
<p>redis-benchmark -h 118.126.92.19 -p 7002 -n 100000 -c 50 -t get -a “$(cat &#x2F;etc&#x2F;redis&#x2F;redis_password.txt)”</p>
<p>  100000 requests completed in 36.48 seconds<br>  50 parallel clients<br>  3 bytes payload<br>  keep alive: 1<br>  host configuration “save”: 10 2<br>  host configuration “appendonly”: yes<br>  multi-thread: no</p>
<p>Summary:<br>  throughput summary: 2741.00 requests per second<br>  latency summary (msec):<br>          avg       min       p50       p95       p99       max<br>       18.082     0.168     0.271   207.487   247.295  3000.319</p>
<p>批量插入：</p>
<p>java客户端进行操作</p>
<p>import org.junit.After;<br>import org.junit.Before;<br>import org.junit.Test;<br>import org.redisson.Redisson;<br>import org.redisson.api.RedissonClient;<br>import org.redisson.config.Config;<br>import static org.junit.Assert.assertEquals;<br>import static org.junit.Assert.assertNotNull;</p>
<p>public class RedisClusterInsertTest {<br>    private RedissonClient redisson;</p>
<pre><code>@Before
public void setup() &#123;
    // 创建 Redisson 配置
    Config config = new Config();
    config.useClusterServers()
          .addNodeAddress(&quot;redis://主节点1的IP:7001&quot;, &quot;redis://主节点2的IP:7002&quot;)
          .setPassword(&quot;你的密码&quot;); // 如果设置了密码，添加密码信息

    // 创建 Redisson 客户端
    redisson = Redisson.create(config);
&#125;

@Test
public void testInsertDataToRedisCluster() &#123;
    // 插入数据到 Redis 集群
    for (int i = 1; i &lt;= 1000; i++) &#123;
        String key = &quot;student:class:name:&quot; + i;
        String value = &quot;value_&quot; + i;
        redisson.getBucket(key).set(value);
    &#125;

    // 验证数据是否插入成功
    for (int i = 1; i &lt;= 1000; i++) &#123;
        String key = &quot;student:class:name:&quot; + i;
        String value = redisson.getBucket(key).get();
        assertNotNull(value);
        assertEquals(&quot;value_&quot; + i, value);
    &#125;
&#125;

@After
public void cleanup() &#123;
    // 关闭 Redisson 客户端
    if (redisson != null) &#123;
        redisson.shutdown();
    &#125;
&#125;
</code></pre>
<p>}</p>
<p>10特点 高可用，数据一致，</p>
<p>1主从复制：当有set操作，主节点会把set这一操作复制给其他主节点，在主节点复制完毕后，从节点会收到主节点的复制信息，这一过程就叫主从同步</p>
<p>2数据分片:一个redis集群共享16384个槽位，集群三主三从，一主一从占用5461个槽位,可以根据key的前缀是有规律的，指定不同类型的数据存放到不同的主从节点上，这在实现数据分片负载均衡的同时也实现了数据分区。</p>
<p>3读写分离:set操作进入3个主节点，get操作进入3个从节点,在最佳实践中，一般会有3个主节点和多个从节点，实现读操作的负载均衡。主节点在高性能的服务器上，从节点可在稍微差点的服务器上。</p>
<p>4故障转移 : 当其中一个主节点挂了，如果足够多的 Sentinel 实例达成共识，它们将执行自动故障转移，并将一个从节点晋升为新的主节点。这一过程是自动的，无需手动干预。当master恢复了，就会变为当前master的slave。</p>
<p>5数据分区：key的前缀相同，大概率是会打到同一个哈希范围槽上，而不是绝对的，但是有一部分的数据会集中在某个master上，其他master也会均匀分布，因为集群注意负载均衡，不可能这些数据都保存在某个master上，当大量请求并发，该master会承受巨大压力。</p>
<p>只要通过key的特殊前缀即可实现数据分区，加上集群本身就自己实现了slot哈希分区，所以我们在定义key的时候，例如:student:class:name:01  student:teacher:name:01这种来讲数据区分开，前缀经过某种s算法，会计算在某个指定范围的槽位内，这样就实现了数据的分区。</p>
<p>”{}“，{}内的内容就是key前缀，当使用{}之后，key的前缀就只会根据括号内容计算</p>
<p>**118.126.92.19:7001&gt; cluster keyslot {user}user1<br>(integer) 5474<br>118.126.92.19:7001&gt; cluster keyslot {user}user2<br>(integer) 5474<br>118.126.92.19:7001&gt; cluster keyslot {user}user3<br>(integer) 5474<br>118.126.92.19:7001&gt; **</p>
<p>每个实例在不同的云服务器上，每台云服务器的内存不一样，redis实例的性能也就不一样，但是组成集群后，主节点需要保证在高性能的服务器，保证足够内存，因为，master需要进行读写操作分离和主从复制，同时也存储了集群中的key。</p>
<p>在 Redis 集群中，哈希槽位是均匀分配的，因此不会出现某个范围的槽位即将用尽而其他范围存在大量空余的情况。每个范围内的槽位数量应该是相等的，以确保负载均衡。</p>
<ol>
<li><strong>整合键（Key Sharding）</strong>：将多个相关键存储在同一个范围内的槽位上，以便更好地均衡槽位的负载。这需要在应用程序中实现自定义逻辑，以确保相关键分布在相同的槽位范围内。</li>
<li><strong>扩大槽位范围</strong>：可以手动扩大一个范围内的槽位数量，以腾出更多的空间来存储键。这需要小心操作，以确保不会导致数据不均衡。在 Redis 集群中，可以通过 <code>CLUSTER ADDSLOTS</code> 命令来手动分配槽位。</li>
</ol>
<p>6网络安全：防火墙和安全组开启限制对redis集群端口的访问</p>
<p>设置密码: </p>
<p>redis.conf –&gt; requirepass:xxx</p>
<p>docker cp redis_password.txt redis-7001:&#x2F;etc&#x2F;redis</p>
<p>redis-cli -c -h 118.126.92.19 -p 7003 -a “$(cat &#x2F;etc&#x2F;redis&#x2F;redis_password.txt)”</p>
<p>确保密码文件的权限受到保护，以防止未经授权的访问。</p>
<p>7性能优化：</p>
<p>关闭虚拟内存：vm-enabled no,</p>
<p>数据备份: save 10 2 ，10s之内有两个键被更改，则保存到rdb文件中； aof，追加文件日志，记录所有对写操作，以便主从同步和数据恢复。挂载到了data目录下。容器内即使实例rm掉，其下的data文件依旧存在。</p>
<p>无磁盘同步:启用 <code>repl-diskless-sync</code> 选项后，Redis会尝试在不写入磁盘的情况下将数据直接从内存中同步到从节点。这可以提高同步性能，减少了对磁盘的写入操作，从而减小了主从同步期间的延迟。这对于需要低延迟的应用场景非常有用。</p>
<p>11.logs日志：</p>
<p>shutdown之前会进行数据的保存备份</p>
<p>Calling fsync() on the AOF file.<br>1:M 14 Oct 2023 03:10:00.558 * Saving the final RDB snapshot before exiting.<br>1:M 14 Oct 2023 03:10:00.560 * DB saved on disk</p>
<p>主从同步，从节点要求复制数据，根据id是否一致判断是增量同步还是全量同步，后台保存同步到磁盘</p>
<p> 14 Oct 2023 03:12:42.811 * Replica 118.126.92.19:7003 asks for synchronization<br>1:M 14 Oct 2023 03:12:42.811 * Partial resynchronization not accepted: Replication ID mismatch (Replica asked for ‘d my replication IDs are ‘060d7fd63fc424fb54fdbfd6ae76987126f2c63d’ and ‘0000000000000000000000000000000000000000’)<br>1:M 14 Oct 2023 03:12:42.811 * Replication backlog created, my new replication IDs are ‘1c2dc99e7de0e7f36c4965e06e0e000000000000000000’<br>1:M 14 Oct 2023 03:12:42.811 * Starting BGSAVE for SYNC with target: disk<br>1:M 14 Oct 2023 03:12:42.812 * Background saving started by pid 19<br>19:C 14 Oct 2023 03:12:42.814 * DB saved on disk<br>19:C 14 Oct 2023 03:12:42.814 * RDB: 0 MB of memory used by copy-on-write<br>1:M 14 Oct 2023 03:12:42.901 * Background saving terminated with success<br>1:M 14 Oct 2023 03:12:42.901 * Synchronization with replica 118.126.92.19:7003 succeeded</p>
<p>用跨协议脚本攻击</p>
<p>1:M 14 Oct 2023 03:30:09.747 # Possible SECURITY ATTACK detected. It looks like somebody is sending POST or Host: commands to Red attacker attempting to use Cross Protocol Scripting to compromise your Redis instance. Connection aborted.<br>1:M 14 Oct 2023 07:02:10.226 # Possible SECURITY ATTACK detected. It looks like somebody is sending POST or Host: commands to Red attacker attempting to use Cross Protocol Scripting to compromise your Redis instance. Connection aborted.<br>1:M 14 Oct 2023 07:11:35.388 # Bad message length or signature received from Cluster bus.</p>
<p>主从切换&#x2F;配置更新,aof文件数据同步,CLUSTER FAILOVER FORCE</p>
<p>1:M 14 Oct 2023 07:13:04.756 # Configuration change detected. Reconfiguring myself as a replica of 5350333b8a457a8bd1e8b02bbab58c<br>1:S 14 Oct 2023 07:13:04.756 # Connection with replica 118.126.92.19:7003 lost.<br>1:S 14 Oct 2023 07:13:04.756 * Before turning into a replica, using my own master parameters to synthesize a cached master: I may the new master with just a partial transfer.<br>1:S 14 Oct 2023 07:13:04.756 * Connecting to MASTER 118.126.92.19:7003<br>1:S 14 Oct 2023 07:13:04.756 * MASTER &lt;-&gt; REPLICA sync started<br>1:S 14 Oct 2023 07:13:04.768 * Non blocking connect for SYNC fired the event.<br>1:S 14 Oct 2023 07:13:04.780 * Master replied to PING, replication can continue…<br>1:S 14 Oct 2023 07:13:04.803 * Trying a partial resynchronization (request 1c2dc99e7de0e7f36c4965e06e0e0d124c939053:20119).<br>1:S 14 Oct 2023 07:13:04.815 * Full resync from master: 230621cedfef6d292aa3fd4fb381e989818d48c1:20062<br>1:S 14 Oct 2023 07:13:04.815 * Discarding previously cached master state.<br>1:S 14 Oct 2023 07:13:04.841 * MASTER &lt;-&gt; REPLICA sync: receiving 176 bytes from master to disk<br>1:S 14 Oct 2023 07:13:04.842 * MASTER &lt;-&gt; REPLICA sync: Flushing old data<br>1:S 14 Oct 2023 07:13:04.842 * MASTER &lt;-&gt; REPLICA sync: Loading DB in memory<br>1:S 14 Oct 2023 07:13:04.843 * Loading RDB produced by version 6.2.6<br>1:S 14 Oct 2023 07:13:04.843 * RDB age 0 seconds<br>1:S 14 Oct 2023 07:13:04.843 * RDB memory usage when created 2.56 Mb<br>1:S 14 Oct 2023 07:13:04.843 # Done loading RDB, keys loaded: 0, keys expired: 0.<br>1:S 14 Oct 2023 07:13:04.843 * MASTER &lt;-&gt; REPLICA sync: Finished with success<br>1:S 14 Oct 2023 07:13:04.844 * Background append only file rewriting started by pid 29<br>1:S 14 Oct 2023 07:13:04.867 * AOF rewrite child asks to stop sending diffs.<br>29:C 14 Oct 2023 07:13:04.867 * Parent agreed to stop sending diffs. Finalizing AOF…<br>29:C 14 Oct 2023 07:13:04.867 * Concatenating 0.00 MB of AOF diff received from parent.<br>29:C 14 Oct 2023 07:13:04.867 * SYNC append only file rewrite performed<br>29:C 14 Oct 2023 07:13:04.868 * AOF rewrite: 0 MB of memory used by copy-on-write<br>1:S 14 Oct 2023 07:13:04.957 * Background AOF rewrite terminated with success<br>1:S 14 Oct 2023 07:13:04.957 * Residual parent diff successfully flushed to the rewritten AOF (0.00 MB)<br>1:S 14 Oct 2023 07:13:04.958 * Background AOF rewrite finished successfully<br>1:S 14 Oct 2023 07:17:54.386 # Cluster state changed: fail<br>1:S 14 Oct 2023 07:18:28.121 # MASTER timeout: no data nor PING received…<br>1:S 14 Oct 2023 07:18:28.121 # Connection with master lost.<br>1:S 14 Oct 2023 07:18:28.121 * Caching the disconnected master state.</p>
<p>12哨兵监听主节点</p>
<p>Redis Sentinel 是一个独立的进程，用于监控 Redis 主从节点的健康状态，并在主节点不可用时触发自动切换操作。</p>
<p>sudo apt update<br>sudo apt install redis-sentinel</p>
<p>redis-sentinel –version</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">version: &#x27;3.7&#x27;</span><br><span class="line">services:</span><br><span class="line">  sentinel1:</span><br><span class="line">    image: redis</span><br><span class="line">    container_name: redis-sentinel-1</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - 26379:26379</span><br><span class="line">    command: redis-sentinel /usr/local/etc/redis/sentinel.conf</span><br><span class="line">    volumes:</span><br><span class="line">      - ./sentinel1.conf:/usr/local/etc/redis/sentinel.conf</span><br><span class="line">    networks:</span><br><span class="line">      - redis-network  # 连接到名为redis-network的自定义网络 </span><br><span class="line">  sentinel2:</span><br><span class="line">    image: redis</span><br><span class="line">    container_name: redis-sentinel-2</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">    - 26380:26380</span><br><span class="line">    command: redis-sentinel /usr/local/etc/redis/sentinel.conf</span><br><span class="line">    volumes:</span><br><span class="line">      - ./sentinel2.conf:/usr/local/etc/redis/sentinel.conf</span><br><span class="line">    networks:</span><br><span class="line">      - redis-network  # 连接到名为redis-network的自定义网络  </span><br><span class="line">  sentinel3:</span><br><span class="line">    image: redis</span><br><span class="line">    container_name: redis-sentinel-3</span><br><span class="line">    ports:</span><br><span class="line">      - 26381:26381</span><br><span class="line">    command: redis-sentinel /usr/local/etc/redis/sentinel.conf</span><br><span class="line">    volumes:</span><br><span class="line">      - ./sentinel3.conf:/usr/local/etc/redis/sentinel.conf</span><br><span class="line">    networks:</span><br><span class="line">      - redis-network  # 连接到名为redis-network的自定义网络    </span><br><span class="line">      </span><br><span class="line">networks:</span><br><span class="line">  redis-network:</span><br><span class="line">    driver: bridge</span><br></pre></td></tr></table></figure>



<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">port 26379</span><br><span class="line">dir /tmp</span><br><span class="line">sentinel monitor mymaster1 118.126.92.19:7001 2</span><br><span class="line">sentinel down-after-milliseconds mymaster1 30000</span><br><span class="line">sentinel failover-timeout mymaster1 180000</span><br><span class="line">sentinel parallel-syncs mymaster1 1</span><br><span class="line">sentinel deny-scripts-reconfig yes</span><br><span class="line"></span><br><span class="line">sentinel monitor mymaster2 118.126.92.19:7002 2</span><br><span class="line">sentinel down-after-milliseconds mymaster2 30000</span><br><span class="line">sentinel failover-timeout mymaster2 180000</span><br><span class="line">sentinel parallel-syncs mymaster2 1</span><br><span class="line">sentinel deny-scripts-reconfig yes</span><br><span class="line"></span><br><span class="line">sentinel monitor mymaster3 47.113.207.230:7001 2</span><br><span class="line">sentinel down-after-milliseconds mymaster3 30000</span><br><span class="line">sentinel failover-timeout mymaster3 180000</span><br><span class="line">sentinel parallel-syncs mymaster3 1</span><br><span class="line">sentinel deny-scripts-reconfig yes</span><br></pre></td></tr></table></figure>

<p>redis-sentinel &#x2F;app&#x2F;redis&#x2F;sentinel.conf</p>
<p>哨兵集群需要额外的开销，会占用资源和线程，，一般是奇数哨兵。</p>
<p>1.一般独立放在一台服务器上，保证其和redis集群的分离，避免和主节点放在一起，假如该台机器宕机，投票系统可能会出现问题</p>
<p>2.每次在故障转移期间将副本提升为主节点以及每次发现新的 Sentinel 时，配置也会被重写。</p>
<p>3.考虑到内存占用，暂时没有安装，大概率也不会节点宕机</p>
<p>13redis最佳实践：</p>
<p>多台云服务器，每台一个redis实例和一个sentinel实例，redis组成集群，sentinel也组成集群，sentinel集群监听redis集群的主节点，</p>
<p>14客户端连接</p>
<p>将客户端放在Windows上，减少云服务器内存，但是这就把redis实例集群放到了0.0.0.0上，所有ip都可以请求连接，所以需要密码</p>
<p>但是如果把客户端安装在服务器上，会占用内存资源，虽然是安全的，因为redis和insight都在同一个局域网内，后续直接Windows 进行http访问即可。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://tk666ttkk.github.io">tk</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://tk666ttkk.github.io/2023/10/21/Redis%E9%9B%86%E7%BE%A4/">https://tk666ttkk.github.io/2023/10/21/Redis集群/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://tk666ttkk.github.io" target="_blank">Hxtk_blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Redis%E9%9B%86%E7%BE%A4/">Redis集群</a></div><div class="post_share"><div class="social-share" data-image="/img/rediscluster.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.png" target="_blank"><img class="post-qr-code-img" src="/img/wechat.png" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.png" target="_blank"><img class="post-qr-code-img" src="/img/alipay.png" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2023/10/21/%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/" title="开发环境配置"><img class="cover" src="/img/kaifa.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">开发环境配置</div></div></a></div></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Hxtk</div><div class="author-info__description">blogger</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">8</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/tk666ttkk?tab=repositories"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/tk666ttkk?tab=repositories" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:1711660323@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">个人博客，仅供学习交流</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%86%E7%BE%A4%E4%BC%81%E4%B8%9A%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98"><span class="toc-text">Redis分布式集群企业开发实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83"><span class="toc-text">本地开发环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83"><span class="toc-text">实际生产环境</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E6%88%91%E7%9A%84%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E6%96%B0%E5%BB%BAredis%E9%9B%86%E7%BE%A4%EF%BC%8C%E5%B9%B6%E8%BF%9E%E6%8E%A5"><span class="toc-text">在我的云服务器上新建redis集群，并连接</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/10/21/Redis%E9%9B%86%E7%BE%A4/" title="Redis集群"><img src="/img/rediscluster.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis集群"/></a><div class="content"><a class="title" href="/2023/10/21/Redis%E9%9B%86%E7%BE%A4/" title="Redis集群">Redis集群</a><time datetime="2023-10-21T09:59:22.000Z" title="发表于 2023-10-21 17:59:22">2023-10-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/10/21/%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/" title="开发环境配置"><img src="/img/kaifa.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="开发环境配置"/></a><div class="content"><a class="title" href="/2023/10/21/%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/" title="开发环境配置">开发环境配置</a><time datetime="2023-10-21T09:57:30.000Z" title="发表于 2023-10-21 17:57:30">2023-10-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/09/mst/" title="面试题"><img src="/img/mst.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="面试题"/></a><div class="content"><a class="title" href="/2023/09/09/mst/" title="面试题">面试题</a><time datetime="2023-09-09T06:17:32.000Z" title="发表于 2023-09-09 14:17:32">2023-09-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/08/rk/" title="rk"><img src="/img/rk.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="rk"/></a><div class="content"><a class="title" href="/2023/09/08/rk/" title="rk">rk</a><time datetime="2023-09-08T10:49:38.000Z" title="发表于 2023-09-08 18:49:38">2023-09-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/08/redis/" title="Redis"><img src="/img/redis.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis"/></a><div class="content"><a class="title" href="/2023/09/08/redis/" title="Redis">Redis</a><time datetime="2023-09-08T10:49:38.000Z" title="发表于 2023-09-08 18:49:38">2023-09-08</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/rediscluster.png')"><div id="footer-wrap"><div class="copyright">&copy;2023 By Hxtk</div><div class="footer_custom_text"><a href= https://cloud.tencent.com/product/ba ><img class="icp-icon" src= /img/icp.jpg><span>湘ICP备2023009473号</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>function getGiscusTheme (theme) {
  return theme === 'dark' ? 'dark' : 'light'
}

function loadGiscus () {
  const config = Object.assign({
    src: 'https://giscus.app/client.js',
    'data-repo': 'tk666ttkk/tk666ttkk.github.io',
    'data-repo-id': 'R_kgDOKPLOqw',
    'data-category-id': 'DIC_kwDOKPLOq84CZHfG',
    'data-mapping': 'pathname',
    'data-theme': getGiscusTheme(document.documentElement.getAttribute('data-theme')),
    'data-reactions-enabled': '1',
    crossorigin: 'anonymous',
    async: true
  },null)

  let ele = document.createElement('script')
  for (let key in config) {
    ele.setAttribute(key, config[key])
  }
  document.getElementById('giscus-wrap').insertAdjacentElement('afterbegin',ele)
}

function changeGiscusTheme (theme) {
  function sendMessage(message) {
    const iframe = document.querySelector('iframe.giscus-frame')
    if (!iframe) return
    iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app')
  }

  sendMessage({
    setConfig: {
      theme: getGiscusTheme(theme)
    }
  });
}

btf.addModeChange('giscus', changeGiscusTheme)

if ('Giscus' === 'Giscus' || !true) {
  if (true) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
  else loadGiscus()
} else {
  function loadOtherComment () {
    loadGiscus()
  }
}</script></div><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="true" data-text="复,临,泰,大壮,夬,乾,姤,遯,否,观,剥,坤" data-fontsize="15px" data-random="true" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><!-- hexo injector body_end start --><script data-pjax>
  function card_artitalk_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-shuo"><div class="card-content" style="height:auto;min-height:280px;"><div class="item-headline"><i class="fas fa-comments"></i><span><a href="/artitalk/" title="artitalk page link">碎碎念</a></span><a id="cardVisual" style="cursor:pointer;float:right" onclick="cardVisual()">编辑</a></div><div id="artitalk_main" style="width:100%;height:100%;padding:1px"></div></div></div>';
    console.log('已挂载card_artitalk');
    parent_div_git.insertAdjacentHTML("afterbegin",item_html);
    (()=>{
      const init = () => {
        new Artitalk(Object.assign({
          appId: 'OkB15hnqeT37KHfurnrEnXIW-MdYXbMMI',
          appKey: 'aljqMsJRItPGAnOMAw2H3I8b',
        }, {"serverURL":"https://OkB15hnq.api.lncldglobal.com","lang":"zh","pageSize":1,"color1":"#49b1f5","color2":"#00c4b6","atEmoji":{"Mafumafu1":"https://cdn.jsdelivr.net/gh/GamerNoTitle/ValineCDN@master/Mafumafu/199749454.png","Mafumafu2":"https://cdn.jsdelivr.net/gh/GamerNoTitle/ValineCDN@master/Mafumafu/199749455.png"}} ))
      }
      if (typeof Artitalk === 'function') {
        init()
      } else {
        getScript('https://npm.elemecdn.com/artitalk').then(init)
      }
    })()
    }
  var elist = '/artitalk/,/posts/'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    card_artitalk_injector_config();
  }
  else if (epage === cpage){
    card_artitalk_injector_config();
  }
  </script><script async src="https://npm.elemecdn.com/hexo-butterfly-artitalk-pro/lib/card_visual.js"></script><!-- hexo injector body_end end --></body></html>