<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>面试题 | Hxtk_blog</title><meta name="author" content="Hxtk"><meta name="copyright" content="Hxtk"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="面试题">
<meta property="og:type" content="article">
<meta property="og:title" content="面试题">
<meta property="og:url" content="https://tk666ttkk.github.io/2023/09/09/mst/index.html">
<meta property="og:site_name" content="Hxtk_blog">
<meta property="og:description" content="面试题">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://tk666ttkk.github.io/img/mst.png">
<meta property="article:published_time" content="2023-09-09T06:17:32.000Z">
<meta property="article:modified_time" content="2023-09-09T06:17:37.000Z">
<meta property="article:author" content="Hxtk">
<meta property="article:tag" content="面试题">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tk666ttkk.github.io/img/mst.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://tk666ttkk.github.io/2023/09/09/mst/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":true,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":100,"languages":{"author":"作者: Hxtk","link":"链接: ","source":"来源: Hxtk_blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '面试题',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-09-09 14:17:37'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-artitalk-pro/lib/card.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (false) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">8</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 目录</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 资源</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url('/img/mst.png')"><nav id="nav"><span id="blog-info"><a href="/" title="Hxtk_blog"><span class="site-name">Hxtk_blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 目录</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 资源</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">面试题</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-09-09T06:17:32.000Z" title="发表于 2023-09-09 14:17:32">2023-09-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-09-09T06:17:37.000Z" title="更新于 2023-09-09 14:17:37">2023-09-09</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%9D%A2%E8%AF%95%E9%A2%98/">面试题</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">7.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>27分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="面试题"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="学成在线项目的面试题："><a href="#学成在线项目的面试题：" class="headerlink" title="学成在线项目的面试题："></a>学成在线项目的面试题：</h1><h2 id="1-Maven："><a href="#1-Maven：" class="headerlink" title="1.Maven："></a>1.Maven：</h2><p>mvn clean compile test package install deploy 清除target 编译源代码 执行单元测试 打包 打包并保存到本地 打包并上传到服务器 </p>
<h3 id="1-1依赖版本冲突怎么处理："><a href="#1-1依赖版本冲突怎么处理：" class="headerlink" title="1.1依赖版本冲突怎么处理："></a>1.1依赖版本冲突怎么处理：</h3><p>1.使用exclusion排除依赖 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 排除 Spring Boot 依赖的日志包冲突 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">    &lt;exclusions&gt;</span><br><span class="line">        &lt;exclusion&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-logging&lt;/artifactId&gt;</span><br><span class="line">        &lt;/exclusion&gt;</span><br><span class="line">    &lt;/exclusions&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>2.通常在父工程对依赖版本进行曲管理</p>
<p>在父工程的pom.xml文件中使用dependencymanager进行依赖版本的管理即可。</p>
<p>1.2</p>
<h2 id="2-Mysql"><a href="#2-Mysql" class="headerlink" title="2.Mysql"></a>2.Mysql</h2><h3 id="2-1Mysql-常见的存储引擎和区别："><a href="#2-1Mysql-常见的存储引擎和区别：" class="headerlink" title="2.1Mysql 常见的存储引擎和区别："></a>2.1Mysql 常见的存储引擎和区别：</h3><h4 id="1-InnoDB"><a href="#1-InnoDB" class="headerlink" title="1.InnoDB"></a>1.InnoDB</h4><p>1.支持事务控制</p>
<p>2.使用的锁粒度默认为行级锁，可以支持更高的并发，也支持表锁。</p>
<p>3.支持外键约束；外键约束其实降低了表的查询速度，增加了表之间的耦合度。</p>
<h4 id="2-MyISAM"><a href="#2-MyISAM" class="headerlink" title="2.MyISAM"></a>2.MyISAM</h4><p>1.不提供事务支持</p>
<p>2.只支持表级锁</p>
<p>3.不支持外键</p>
<h4 id="3-memory"><a href="#3-memory" class="headerlink" title="3.memory"></a>3.memory</h4><p>数据存储在内存中</p>
<h4 id="4-总结："><a href="#4-总结：" class="headerlink" title="4.总结："></a>4.总结：</h4><p>InnoDB用于事务处理，具有ACID事务支持等特性，应用中需执行大量的insert &amp;&amp; update 等操作</p>
<p>MyISAM管理非事务表，提供高速存储和检索以及全文搜索的能力，应用需执行大量select</p>
<h3 id="2-2Mysql建表注意事项"><a href="#2-2Mysql建表注意事项" class="headerlink" title="2.2Mysql建表注意事项:"></a>2.2Mysql建表注意事项:</h3><h4 id="1-存储引擎"><a href="#1-存储引擎" class="headerlink" title="1.存储引擎"></a>1.存储引擎</h4><p>是否支持事务控制</p>
<h4 id="2-字段类型选择"><a href="#2-字段类型选择" class="headerlink" title="2.字段类型选择"></a>2.字段类型选择</h4><p>日期：datetime （时分秒） date（年月日）</p>
<p>字符：固定长度 char 不定长 varchar</p>
<p>长文本: text longtest</p>
<p>图片等二进制数据：blob，longblob</p>
<p>金额: DECIMAL</p>
<p>数值类型：确保取值范围足够的前提下使用较小空间的类型</p>
<h4 id="3-字段"><a href="#3-字段" class="headerlink" title="3.字段"></a>3.字段</h4><p>3.1自然主键（id就好）建议使用int unsigned类型, 该主键不能有业务意义，特殊场景使用bigint</p>
<p>3.2如果要存储test，blob字段建议单独建表，在使用外键关联</p>
<p>3.3尽量不要定义外键，保证表的独立性，可以存在外键意义的字段</p>
<p>3.4设置字段的默认值，并写清楚注释，注意字段的约束（非空，唯一，主键等）</p>
<h3 id="2-3Mysql如何查询树形表"><a href="#2-3Mysql如何查询树形表" class="headerlink" title="2.3Mysql如何查询树形表"></a>2.3Mysql如何查询树形表</h3><p>树形表的标记字段是parentid即父节点的id</p>
<p>有两种方法：</p>
<p>1）当层级固定时可以使用表的自连接</p>
<p>2）如果想灵活查询每一个层级可以使用mysql递归的方法，使用 with RESCURSIVE</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">with recursive t1 <span class="title function_">as</span> <span class="params">(</span></span><br><span class="line"><span class="params">    select * from course_category where id=#&#123;id&#125;</span></span><br><span class="line"><span class="params">    union all</span></span><br><span class="line"><span class="params">    select t2.* from course_category t2 inner join t1 on t1.id = t2.parentid</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">select * from t1</span><br><span class="line">order by t1.id</span><br></pre></td></tr></table></figure>

<h2 id="3-SpingBoot"><a href="#3-SpingBoot" class="headerlink" title="3.SpingBoot"></a>3.SpingBoot</h2><h3 id="3-1springBoot接口开发常用的注解有哪些："><a href="#3-1springBoot接口开发常用的注解有哪些：" class="headerlink" title="3.1springBoot接口开发常用的注解有哪些："></a>3.1springBoot接口开发常用的注解有哪些：</h3><p>1.@Controller标记此类是控制器，可以返回视图解析器指定的html页面，通过@ResponseBody可以将结果返回json，xml数据</p>
<p>2.RestController相当于@ResponseBody+@Controller实现rest接口开发，返回json数据，不能返回html页面。</p>
<p>3.RequestMapping定义接口地址，类或方法上方，支持http的post，put，get</p>
<p>4.PostMapping 定义post接口，添加记录，复杂条件的查询接口</p>
<p>5.GetMapping 定义get接口，查询接口</p>
<p>6.PutMapping 定义put接口，修改接口</p>
<p>7.DeleteMapping 定义delete接口，删除接口，</p>
<p>8.@RequestBody 定义在方法上，将json串数据转为java对象。</p>
<p>9.@PathVarible 接收请求路径中的占位符的值，地址传参</p>
<p>10.@ApiOperation swagger 注解，对接口方法进行说明</p>
<p>11.@Autowired 基于类型注入service接口，从容器中找到service的javabean</p>
<p>12.@Resource 基于名称注入，失败则转化为进行基于类型注入</p>
<p>13.@Api swagger 注解，读接口类进行说明</p>
<h3 id="3-2请求参数的合法性校验"><a href="#3-2请求参数的合法性校验" class="headerlink" title="3.2请求参数的合法性校验"></a>3.2请求参数的合法性校验</h3><h4 id="3-2-1数据的校验"><a href="#3-2-1数据的校验" class="headerlink" title="3.2.1数据的校验"></a>3.2.1数据的校验</h4><p>必填项校验，数据格式校验（非空，是否符合日期格式）</p>
<p>基于JSR303校验框架实现，SpringBoot提供了JSR-303的支持，它就是spring-boot-starter-validation,它包含很多校验规则，只需要在模型类中通过注解指定校验规则，在controller方法上开启。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.api;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@ApiOperation(&quot;新增课程&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/course&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">createCourseBase</span><span class="params">(<span class="meta">@RequestBody</span> <span class="meta">@Validated(ValidationGroups.Inster.class)</span> AddCourseDto addCourseDto)</span>&#123;</span><br><span class="line"></span><br><span class="line">        SecurityUtil.<span class="type">XcUser</span> <span class="variable">user</span> <span class="operator">=</span> SecurityUtil.getUser();</span><br><span class="line">        System.out.println(user);</span><br><span class="line">        <span class="comment">//获取到用户所属机构的id</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">companyId1</span> <span class="operator">=</span> user.getCompanyId();</span><br><span class="line"></span><br><span class="line">        <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> Long.parseLong(companyId1);</span><br><span class="line"><span class="comment">//        int i = 1/0;</span></span><br><span class="line">        <span class="type">CourseBaseInfoDto</span> <span class="variable">courseBase</span> <span class="operator">=</span> courseBaseInfoService.createCourseBase(companyId, addCourseDto);</span><br><span class="line">        <span class="keyword">return</span> courseBase;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.model.dto;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(value=&quot;AddCourseDto&quot;, description=&quot;新增课程基本信息&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AddCourseDto</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@NotEmpty(message = &quot;新增课程名称不能为空&quot;,groups=&#123;ValidationGroups.Inster.class&#125;)</span></span><br><span class="line"> <span class="meta">@NotEmpty(message = &quot;修改课程名称不能为空&quot;,groups=&#123;ValidationGroups.Update.class&#125;)</span></span><br><span class="line"><span class="comment">// @NotEmpty(message = &quot;课程名称不能为空&quot;)</span></span><br><span class="line"> <span class="meta">@ApiModelProperty(value = &quot;课程名称&quot;, required = true)</span></span><br><span class="line"> <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@NotEmpty(message = &quot;适用人群不能为空&quot;)</span></span><br><span class="line"> <span class="meta">@Size(message = &quot;适用人群内容过少&quot;,min = 10)</span></span><br><span class="line"> <span class="meta">@ApiModelProperty(value = &quot;适用人群&quot;, required = true)</span></span><br><span class="line"> <span class="keyword">private</span> String users;</span><br></pre></td></tr></table></figure>

<p>校验分组：不同类型的校验需要不同的组</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.base.exception;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 用于分级校验，定义一些常用的组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/2/14 9:37</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ValidationGroups</span> &#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Inster</span>&#123;&#125;;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Update</span>&#123;&#125;;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Delete</span>&#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-2业务逻辑的校验"><a href="#3-2-2业务逻辑的校验" class="headerlink" title="3.2.2业务逻辑的校验"></a>3.2.2业务逻辑的校验</h4><p>在service中校验即可，例如判断只有本机构才能修改本机构的课程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//数据合法性校验</span></span><br><span class="line"><span class="comment">//根据具体的业务逻辑去校验</span></span><br><span class="line"><span class="comment">//本机构只能修改本机构的课程</span></span><br><span class="line"><span class="keyword">if</span>(!companyId.equals(courseBase.getCompanyId()))&#123;</span><br><span class="line">    XueChengPlusException.cast(<span class="string">&quot;本机构只能修改本机构的课程&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-Mybatis"><a href="#4-Mybatis" class="headerlink" title="4.Mybatis"></a>4.Mybatis</h2><h3 id="4-1Mybatis分页插件原理"><a href="#4-1Mybatis分页插件原理" class="headerlink" title="4.1Mybatis分页插件原理:"></a>4.1Mybatis分页插件原理:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.auth.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> *；</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;P&gt;</span></span><br><span class="line"><span class="comment"> *        Mybatis-Plus 配置</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.xuecheng.ucenter.mapper&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisPlusConfig</span> &#123;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 新的分页插件</span></span><br><span class="line"><span class="comment">    * 需要设置 MybatisConfiguration#useDeprecatedExecutor = false</span></span><br><span class="line"><span class="comment">    * 避免缓存出现问题(该属性会在旧插件移除后一同移除)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> MybatisPlusInterceptor <span class="title function_">mybatisPlusInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="type">MybatisPlusInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisPlusInterceptor</span>();</span><br><span class="line">      interceptor.addInnerInterceptor(<span class="keyword">new</span> <span class="title class_">PaginationInnerInterceptor</span>(DbType.MYSQL));</span><br><span class="line">      <span class="keyword">return</span> interceptor;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现原理：首先将分页参数放到ThreadLocal中，拦截执行的sql，根据数据库类型添加对应的分页语句重写sql，例如</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">（<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">table</span> <span class="keyword">where</span> a）<span class="comment">--&gt; (select count(*) from table where a ) 和 （select * from table where a limit）</span></span><br></pre></td></tr></table></figure>

<p>计算出total总条数，pageNum当前第几页，pageSize每页大小和当前页的数据，是否为首尾页和总页数等，</p>
<h3 id="4-2Mybatis的ResultType-和-ResultMap的区别"><a href="#4-2Mybatis的ResultType-和-ResultMap的区别" class="headerlink" title="4.2Mybatis的ResultType 和 ResultMap的区别"></a>4.2Mybatis的ResultType 和 ResultMap的区别</h3><p>Result指定映射的类型，只要查询字段名和类型的属性名匹配即可自动映射，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=<span class="string">&quot;selectTreeNodes&quot;</span>  parameterType=<span class="string">&quot;string&quot;</span> resultType=<span class="string">&quot;com.xuecheng.content.model.dto.CourseCategoryTreeDto&quot;</span>&gt;</span><br><span class="line">    with recursive t1 <span class="title function_">as</span> <span class="params">(</span></span><br><span class="line"><span class="params">        select * from course_category where id=#&#123;id&#125;</span></span><br><span class="line"><span class="params">        union all</span></span><br><span class="line"><span class="params">        select t2.* from course_category t2 inner join t1 on t1.id = t2.parentid</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">    )</span></span><br><span class="line">    select * from t1</span><br><span class="line">    order by t1.id</span><br><span class="line"></span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure>

<p>ResultMap 自定义映射规则，不匹配，实现一对一，一对多的映射。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 通用查询映射结果 --&gt;</span><br><span class="line">&lt;resultMap id=<span class="string">&quot;BaseResultMap&quot;</span> type=<span class="string">&quot;com.xuecheng.content.model.po.CourseCategory&quot;</span>&gt;</span><br><span class="line">    &lt;id column=<span class="string">&quot;id&quot;</span> property=<span class="string">&quot;id&quot;</span> /&gt;</span><br><span class="line">    &lt;result column=<span class="string">&quot;name&quot;</span> property=<span class="string">&quot;name&quot;</span> /&gt;</span><br><span class="line">    &lt;result column=<span class="string">&quot;label&quot;</span> property=<span class="string">&quot;label&quot;</span> /&gt;</span><br><span class="line">    &lt;result column=<span class="string">&quot;parentid&quot;</span> property=<span class="string">&quot;parentid&quot;</span> /&gt;</span><br><span class="line">    &lt;result column=<span class="string">&quot;is_show&quot;</span> property=<span class="string">&quot;isShow&quot;</span> /&gt;</span><br><span class="line">    &lt;result column=<span class="string">&quot;orderby&quot;</span> property=<span class="string">&quot;orderby&quot;</span> /&gt;</span><br><span class="line">    &lt;result column=<span class="string">&quot;is_leaf&quot;</span> property=<span class="string">&quot;isLeaf&quot;</span> /&gt;</span><br><span class="line">&lt;/resultMap&gt;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-和-的区别"><a href="#4-3-和-的区别" class="headerlink" title="4.3 #{} 和${} 的区别"></a>4.3 #{} 和${} 的区别</h3><p>#{} 是标记一个占位符，可以防止sql注入</p>
<p>${} 用于在动态sql中拼接字符串，可能导致sql注入</p>
<h2 id="5-系统如何进行异常处理"><a href="#5-系统如何进行异常处理" class="headerlink" title="5.系统如何进行异常处理"></a>5.系统如何进行异常处理</h2><p>自定义一个统一的异常处理器，去捕获并处理异常</p>
<p>1)处理自定义异常</p>
<p>自定义一个异常类，里面有各种异常的信息，主动抛出自定义类的异常对象，并指出详细异常信息，异常处理器捕获日志记录并响应给用户</p>
<p>2）处理未知异常</p>
<p>异常由异常处理器统一捕获，记录异常日志，统一响应500错误</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.base.exception;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 通用错误信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/6 11:29</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">CommonError</span> &#123;</span><br><span class="line"></span><br><span class="line">   UNKOWN_ERROR(<span class="string">&quot;执行过程异常，请重试。&quot;</span>),</span><br><span class="line">   PARAMS_ERROR(<span class="string">&quot;非法参数&quot;</span>),</span><br><span class="line">   OBJECT_NULL(<span class="string">&quot;对象为空&quot;</span>),</span><br><span class="line">   QUERY_NULL(<span class="string">&quot;查询结果为空&quot;</span>),</span><br><span class="line">   REQUEST_NULL(<span class="string">&quot;请求参数为空&quot;</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> String errMessage;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">getErrMessage</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> errMessage;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="title function_">CommonError</span><span class="params">( String errMessage)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.errMessage = errMessage;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.base.exception;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> *；</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/2/12 17:01</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="comment">//@RestControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalExceptionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//对项目的自定义异常类型进行处理</span></span><br><span class="line">   <span class="meta">@ResponseBody</span></span><br><span class="line">   <span class="meta">@ExceptionHandler(XueChengPlusException.class)</span></span><br><span class="line">   <span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span></span><br><span class="line"> <span class="keyword">public</span> RestErrorResponse <span class="title function_">customException</span><span class="params">(XueChengPlusException e)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//记录异常</span></span><br><span class="line">    log.error(<span class="string">&quot;系统异常&#123;&#125;&quot;</span>,e.getErrMessage(),e);</span><br><span class="line">    <span class="comment">//..</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//解析出异常信息</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">errMessage</span> <span class="operator">=</span> e.getErrMessage();</span><br><span class="line">    <span class="type">RestErrorResponse</span> <span class="variable">restErrorResponse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestErrorResponse</span>(errMessage);</span><br><span class="line">    <span class="keyword">return</span> restErrorResponse;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">//MethodArgumentNotValidException</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(MethodArgumentNotValidException.class)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span></span><br><span class="line">    <span class="keyword">public</span> RestErrorResponse <span class="title function_">methodArgumentNotValidException</span><span class="params">(MethodArgumentNotValidException e)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">BindingResult</span> <span class="variable">bindingResult</span> <span class="operator">=</span> e.getBindingResult();</span><br><span class="line">        <span class="comment">//存储错误信息</span></span><br><span class="line">        List&lt;String&gt; errors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        bindingResult.getFieldErrors().stream().forEach(item-&gt;&#123;</span><br><span class="line">            errors.add(item.getDefaultMessage());</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将list中的错误信息拼接起来</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">errMessage</span> <span class="operator">=</span> StringUtils.join(errors, <span class="string">&quot;,&quot;</span>);</span><br><span class="line">        <span class="comment">//记录异常</span></span><br><span class="line">        log.error(<span class="string">&quot;系统异常&#123;&#125;&quot;</span>,e.getMessage(),errMessage);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//解析出异常信息</span></span><br><span class="line">        <span class="type">RestErrorResponse</span> <span class="variable">restErrorResponse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestErrorResponse</span>(errMessage);</span><br><span class="line">        <span class="keyword">return</span> restErrorResponse;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(Exception.class)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span></span><br><span class="line">    <span class="keyword">public</span> RestErrorResponse <span class="title function_">exception</span><span class="params">(Exception e)</span> &#123;</span><br><span class="line"></span><br><span class="line">        log.error(<span class="string">&quot;【系统异常】&#123;&#125;&quot;</span>,e.getMessage(),e);</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">if</span>(e.getMessage().equals(<span class="string">&quot;不允许访问&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestErrorResponse</span>(<span class="string">&quot;没有操作此功能的权限&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestErrorResponse</span>(CommonError.UNKOWN_ERROR.getErrMessage());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-什么情况下事务回失效："><a href="#6-什么情况下事务回失效：" class="headerlink" title="6.什么情况下事务回失效："></a>6.什么情况下事务回失效：</h2><h3 id="1-在方法中捕获异常没有抛出"><a href="#1-在方法中捕获异常没有抛出" class="headerlink" title="1)在方法中捕获异常没有抛出"></a>1)在方法中捕获异常没有抛出</h3><p>没有throw该异常</p>
<h3 id="2）非事务方法调用事务方法"><a href="#2）非事务方法调用事务方法" class="headerlink" title="2）非事务方法调用事务方法"></a>2）非事务方法调用事务方法</h3><p>此时需要以代理对象去调用，</p>
<p>1.注入当前的service,创建当前的代理对象 </p>
<p>@AutoWired</p>
<p>MediaFileService currentProxy;</p>
<p>2.在事务方法上声明@Transcation</p>
<h3 id="3）事务方法内部调用事务方法"><a href="#3）事务方法内部调用事务方法" class="headerlink" title="3）事务方法内部调用事务方法"></a>3）事务方法内部调用事务方法</h3><p>在一个事务方法中，不是通过当前代理对象去调用另一个事务方法，不会新建另一个新的事务。</p>
<p>@Transactional(propagation &#x3D; Propagation.REQUIRES_NEW)</p>
<h3 id="4-Transactional标记的方法不是public"><a href="#4-Transactional标记的方法不是public" class="headerlink" title="4)@Transactional标记的方法不是public"></a>4)@Transactional标记的方法不是public</h3><h3 id="5-抛出的异常与rollbackFor指定的异常不匹配"><a href="#5-抛出的异常与rollbackFor指定的异常不匹配" class="headerlink" title="5)抛出的异常与rollbackFor指定的异常不匹配"></a>5)抛出的异常与rollbackFor指定的异常不匹配</h3><p>可以在@Transaction()注解中自定义当抛出特定的异常时才需要进行事务控制，进行回滚。</p>
<p>例如 @Transaction(rollbackFor(XxException.class)) </p>
<h3 id="6）数据库表不支持事务处理"><a href="#6）数据库表不支持事务处理" class="headerlink" title="6）数据库表不支持事务处理"></a>6）数据库表不支持事务处理</h3><p>MYISLAM做存储引擎</p>
<h3 id="7）springboot的传播行为导致事务的失效"><a href="#7）springboot的传播行为导致事务的失效" class="headerlink" title="7）springboot的传播行为导致事务的失效"></a>7）springboot的传播行为导致事务的失效</h3><p>@Transaction(PROPAGATION_REQUIRES_NEW)注解中添加需要的代码</p>
<table>
<thead>
<tr>
<th>传播行为</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>PROPAGATION_REQUIRED</td>
<td>当前方法必须在一个事务中运行。如果当前存在事务，方法将加入到当前事务中，如果没有事务，它将创建一个新事务。这是默认的传播行为。</td>
</tr>
<tr>
<td>PROPAGATION_REQUIRES_NEW</td>
<td>创建一个新事务，如果当前存在事务，则将其挂起。新事务独立于当前事务运行。成功提交会影响数据库，失败只会影响新事务。</td>
</tr>
<tr>
<td>PROPAGATION_NESTED</td>
<td>当前方法必须在一个事务中运行，但可以创建一个嵌套事务。嵌套事务有自己的保存点，可以回滚到嵌套事务的开始，不影响外部事务。</td>
</tr>
<tr>
<td>PROPAGATION_SUPPORTS</td>
<td>方法可以在事务中运行，如果没有事务，则在非事务状态下运行。</td>
</tr>
<tr>
<td>PROPAGATION_NOT_SUPPORTED</td>
<td>方法在非事务状态下运行，如果当前存在事务，将其挂起，执行完方法后不会提交事务。</td>
</tr>
<tr>
<td>PROPAGATION_NEVER</td>
<td>方法绝对不能在事务中运行，如果当前存在事务，将抛出异常。</td>
</tr>
<tr>
<td>PROPAGATION_MANDATORY</td>
<td>方法必须在一个已存在的事务中运行，如果没有事务存在，将抛出异常。</td>
</tr>
</tbody></table>
<h3 id="8）总结：只有通过当前代理对象调用的方法才能正确进行事务控制"><a href="#8）总结：只有通过当前代理对象调用的方法才能正确进行事务控制" class="headerlink" title="8）总结：只有通过当前代理对象调用的方法才能正确进行事务控制"></a>8）总结：只有通过当前代理对象调用的方法才能正确进行事务控制</h3><h2 id="7-断点续传"><a href="#7-断点续传" class="headerlink" title="7.断点续传"></a>7.断点续传</h2><p>1）前端对文件进行分块 chunk001</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageResult&lt;MediaFiles&gt; <span class="title function_">queryMediaFiels</span><span class="params">(Long companyId, PageParams pageParams, QueryMediaParamsDto queryMediaParamsDto)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//构建查询条件对象</span></span><br><span class="line">    LambdaQueryWrapper&lt;MediaFiles&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//分页对象</span></span><br><span class="line">    Page&lt;MediaFiles&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(pageParams.getPageNo(), pageParams.getPageSize());</span><br><span class="line">    <span class="comment">// 查询数据内容获得结果</span></span><br><span class="line">    Page&lt;MediaFiles&gt; pageResult = mediaFilesMapper.selectPage(page, queryWrapper);</span><br><span class="line">    <span class="comment">// 获取数据列表</span></span><br><span class="line">    List&lt;MediaFiles&gt; list = pageResult.getRecords();</span><br><span class="line">    <span class="comment">// 获取数据总数</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">total</span> <span class="operator">=</span> pageResult.getTotal();</span><br><span class="line">    <span class="comment">// 构建结果集</span></span><br><span class="line">    PageResult&lt;MediaFiles&gt; mediaListResult = <span class="keyword">new</span> <span class="title class_">PageResult</span>&lt;&gt;(list, total, pageParams.getPageNo(), pageParams.getPageSize());</span><br><span class="line">    <span class="keyword">return</span> mediaListResult;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）前端使用多线程一块一块上传，上传前给服务端发送信息，核验当前当前分块是否已经上传，否则继续上传。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkFile</span><span class="params">(String fileMd5)</span> &#123;</span><br><span class="line">    <span class="comment">//先查询数据库</span></span><br><span class="line">    <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> mediaFilesMapper.selectById(fileMd5);</span><br><span class="line">    <span class="keyword">if</span>(mediaFiles!=<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="comment">//桶</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">bucket</span> <span class="operator">=</span> mediaFiles.getBucket();</span><br><span class="line">        <span class="comment">//objectname</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> mediaFiles.getFilePath();</span><br><span class="line">        <span class="comment">//如果数据库存在再查询 minio</span></span><br><span class="line">        <span class="type">GetObjectArgs</span> <span class="variable">getObjectArgs</span> <span class="operator">=</span> GetObjectArgs.builder()</span><br><span class="line">                .bucket(bucket)</span><br><span class="line">                .object(filePath)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="comment">//查询远程服务获取到一个流对象</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">FilterInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> minioClient.getObject(getObjectArgs);</span><br><span class="line">            <span class="keyword">if</span>(inputStream!=<span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="comment">//文件已存在</span></span><br><span class="line">                <span class="keyword">return</span> RestResponse.success(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//文件不存在</span></span><br><span class="line">    <span class="keyword">return</span> RestResponse.success(<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3）等到所有分块上传完毕，服务端合并所有分块，校验分块的完整性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkChunk</span><span class="params">(String fileMd5, <span class="type">int</span> chunkIndex)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据md5得到分块文件所在目录的路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">chunkFileFolderPath</span> <span class="operator">=</span> getChunkFileFolderPath(fileMd5);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果数据库存在再查询 minio</span></span><br><span class="line">    <span class="type">GetObjectArgs</span> <span class="variable">getObjectArgs</span> <span class="operator">=</span> GetObjectArgs.builder()</span><br><span class="line">            .bucket(bucket_video)</span><br><span class="line">            .object(chunkFileFolderPath+chunkIndex)</span><br><span class="line">            .build();</span><br><span class="line">    <span class="comment">//查询远程服务获取到一个流对象</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">FilterInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> minioClient.getObject(getObjectArgs);</span><br><span class="line">        <span class="keyword">if</span>(inputStream!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//文件已存在</span></span><br><span class="line">            <span class="keyword">return</span> RestResponse.success(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//文件不存在</span></span><br><span class="line">    <span class="keyword">return</span> RestResponse.success(<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分块文件全都上传到了服务器，服务器按顺序进行合并，就是将每一个分块文件按照内容顺序一次写入一个文件中，使用字节流进行读文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> RestResponse <span class="title function_">uploadChunk</span><span class="params">(String fileMd5, <span class="type">int</span> chunk, String localChunkFilePath)</span> &#123;</span><br><span class="line">    <span class="comment">//分块文件的路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">chunkFilePath</span> <span class="operator">=</span> getChunkFileFolderPath(fileMd5) + chunk;</span><br><span class="line">    <span class="comment">//获取mimeType</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">mimeType</span> <span class="operator">=</span> getMimeType(<span class="literal">null</span>);</span><br><span class="line">    <span class="comment">//将分块文件上传到minio</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> addMediaFilesToMinIO(localChunkFilePath, mimeType, bucket_video, chunkFilePath);</span><br><span class="line">    <span class="keyword">if</span>(!b)&#123;</span><br><span class="line">        <span class="keyword">return</span> RestResponse.validfail(<span class="literal">false</span>,<span class="string">&quot;上传分块文件失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//上传成功</span></span><br><span class="line">    <span class="keyword">return</span> RestResponse.success(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse <span class="title function_">mergechunks</span><span class="params">(Long companyId, String fileMd5, <span class="type">int</span> chunkTotal, UploadFileParamsDto uploadFileParamsDto)</span> &#123;</span><br><span class="line">        <span class="comment">//分块文件所在目录</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">chunkFileFolderPath</span> <span class="operator">=</span> getChunkFileFolderPath(fileMd5);</span><br><span class="line">        <span class="comment">//找到所有的分块文件</span></span><br><span class="line">        List&lt;ComposeSource&gt; sources = Stream.iterate(<span class="number">0</span>, i -&gt; ++i).limit(chunkTotal).map(i -&gt; ComposeSource.builder().bucket(bucket_video).object(chunkFileFolderPath + i).build()).collect(Collectors.toList());</span><br><span class="line">        <span class="comment">//源文件名称</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> uploadFileParamsDto.getFilename();</span><br><span class="line">        <span class="comment">//扩展名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">extension</span> <span class="operator">=</span> filename.substring(filename.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">        <span class="comment">//合并后文件的objectname</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">objectName</span> <span class="operator">=</span> getFilePathByMd5(fileMd5, extension);</span><br><span class="line">        <span class="comment">//指定合并后的objectName等信息</span></span><br><span class="line">        <span class="type">ComposeObjectArgs</span> <span class="variable">composeObjectArgs</span> <span class="operator">=</span> ComposeObjectArgs.builder()</span><br><span class="line">                .bucket(bucket_video)</span><br><span class="line">                .object(objectName)<span class="comment">//合并后的文件的objectname</span></span><br><span class="line">                .sources(sources)<span class="comment">//指定源文件</span></span><br><span class="line">                .build();</span><br><span class="line">        <span class="comment">//===========合并文件============</span></span><br><span class="line">        <span class="comment">//报错size 1048576 must be greater than 5242880，minio默认的分块文件大小为5M</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            minioClient.composeObject(composeObjectArgs);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            log.error(<span class="string">&quot;合并文件出错,bucket:&#123;&#125;,objectName:&#123;&#125;,错误信息:&#123;&#125;&quot;</span>,bucket_video,objectName,e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> RestResponse.validfail(<span class="literal">false</span>,<span class="string">&quot;合并文件异常&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//===========校验合并后的和源文件是否一致，视频上传才成功===========</span></span><br><span class="line">        <span class="comment">//先下载合并后的文件</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> downloadFileFromMinIO(bucket_video, objectName);</span><br><span class="line">        <span class="comment">//文件大小</span></span><br><span class="line">        uploadFileParamsDto.setFileSize(file.length());</span><br><span class="line"></span><br><span class="line"><span class="comment">//        try(FileInputStream fileInputStream = new FileInputStream(file))&#123;</span></span><br><span class="line"><span class="comment">//            //计算合并后文件的md5</span></span><br><span class="line"><span class="comment">//            String mergeFile_md5 = DigestUtils.md5Hex(fileInputStream);</span></span><br><span class="line"><span class="comment">//            //比较原始md5和合并后文件的md5</span></span><br><span class="line"><span class="comment">////            if(!fileMd5.equals(mergeFile_md5))&#123;</span></span><br><span class="line"><span class="comment">////                log.error(&quot;校验合并文件md5值不一致,原始文件:&#123;&#125;,合并文件:&#123;&#125;&quot;,fileMd5,mergeFile_md5);</span></span><br><span class="line"><span class="comment">////                return RestResponse.validfail(false,&quot;文件校验失败&quot;);</span></span><br><span class="line"><span class="comment">////            &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        &#125;catch (Exception e) &#123;</span></span><br><span class="line"><span class="comment">//            return RestResponse.validfail(false,&quot;文件校验失败&quot;);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//==============将文件信息入库============</span></span><br><span class="line">        <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> currentProxy.addMediaFilesToDb(companyId, fileMd5, uploadFileParamsDto, bucket_video, objectName);</span><br><span class="line">        <span class="keyword">if</span>(mediaFiles == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> RestResponse.validfail(<span class="literal">false</span>,<span class="string">&quot;文件入库失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//==========清理分块文件=========</span></span><br><span class="line">        clearChunkFiles(chunkFileFolderPath,chunkTotal);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> RestResponse.success(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>4）前端给服务端传了一个md5的值，服务端合并后计算MD5值是否与前端提供的相符，一样则说明文件完整，否则可能出现丢包等导致文件不完整。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取文件的md5</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getFileMd5</span><span class="params">(File file)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file)) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">fileMd5</span> <span class="operator">=</span> DigestUtils.md5Hex(fileInputStream);</span><br><span class="line">        <span class="keyword">return</span> fileMd5;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5）分块文件清理问题</p>
<p>假如上传文件上传到一半，之前存储的minio文件需要清理吗？</p>
<p>1.在数据库中有一张文件记录表记录minio存储的文件信息</p>
<p>2.文件开始上传时会写入文件表，状态为上传中，当上传完毕在更新状态为上传完成</p>
<p>3.当文件没有完全上传成功，会有定时任务查询文件表中的记录，如果没有上传完成则删除minio没有上传成功的文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 清除分块文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> chunkFileFolderPath 分块文件路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> chunkTotal 分块文件总数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">clearChunkFiles</span><span class="params">(String chunkFileFolderPath,<span class="type">int</span> chunkTotal)</span>&#123;</span><br><span class="line">    Iterable&lt;DeleteObject&gt; objects =  Stream.iterate(<span class="number">0</span>, i -&gt; ++i).limit(chunkTotal).map(i -&gt; <span class="keyword">new</span> <span class="title class_">DeleteObject</span>(chunkFileFolderPath+ i)).collect(Collectors.toList());;</span><br><span class="line">    <span class="type">RemoveObjectsArgs</span> <span class="variable">removeObjectsArgs</span> <span class="operator">=</span> RemoveObjectsArgs.builder().bucket(bucket_video).objects(objects).build();</span><br><span class="line">    Iterable&lt;Result&lt;DeleteError&gt;&gt; results = minioClient.removeObjects(removeObjectsArgs);</span><br><span class="line">    <span class="comment">//要想真正删除</span></span><br><span class="line">    results.forEach(f-&gt;&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">DeleteError</span> <span class="variable">deleteError</span> <span class="operator">=</span> f.get();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8-xxl-job"><a href="#8-xxl-job" class="headerlink" title="8.xxl -job"></a>8.xxl -job</h2><h3 id="8-1原理："><a href="#8-1原理：" class="headerlink" title="8.1原理："></a>8.1原理：</h3><p>xxl-job分布式任务调度服务由调用中心和执行器组成，调用中心负责按任务调度策略向执行器下发任务，执行器负责接收任务并执行。</p>
<p>1）部署并启动xxl-job调度中心（java工程）</p>
<p>2）在微服务添加xxl-job的依赖，在微服务中心配置服务器</p>
<p>3）启动微服务，执行器向调度中心上报自己</p>
<p>4）在微服务中写一个方法并用xxl-job的注解去标记执行任务的方法名称</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@XxlJob(&quot;videoJobHandler&quot;)</span></span><br></pre></td></tr></table></figure>

<p>5）调度中心配置任务调度策略</p>
<p>6）在xxl-job调度中心启动任务</p>
<p>7)调度中心根据任务调度策略，到达时间就开始下发任务给执行器</p>
<p>8）执行器收到任务就开始执行</p>
<h3 id="8-2如何保证任务不会重复执行"><a href="#8-2如何保证任务不会重复执行" class="headerlink" title="8.2如何保证任务不会重复执行"></a>8.2如何保证任务不会重复执行</h3><p>1）调度中心按分片广播的方式去下发任务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 2、分片广播任务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@XxlJob(&quot;shardingJobHandler&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shardingJobHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分片参数</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">shardIndex</span> <span class="operator">=</span> XxlJobHelper.getShardIndex();<span class="comment">//执行器的序号，从0开始</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">shardTotal</span> <span class="operator">=</span> XxlJobHelper.getShardTotal();<span class="comment">//执行器总数</span></span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;shardIndex=&quot;</span>+shardIndex+<span class="string">&quot;,shardTotal=&quot;</span>+shardTotal);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/xxl-job.png"></p>
<p>2）执行器收到作业分片广播的参数：分片总数和分片序号，计算 任务id &#x2F; 分片总数 得到一个余数，如果余数等于分片序号，当前执行器就去执行这个任务，这里保证了不同的执行器执行不同的任务。</p>
<p>例如：分片总数为2，分片序号0,1，2，3，两个任务，从任务1开始：假设当前执行器是2</p>
<p>1 % 2 &#x3D; 1 执行器2执行</p>
<p>2 % 2 &#x3D; 0 执行器1执行</p>
<p>3 % 2 &#x3D; 1 执行器2执行</p>
<p>3）配置调度过期策略为“忽略”，避免同一个执行器多次重复执行同一个任务。</p>
<p>4）配置任务阻塞处理策略为“丢弃后续调度”，注意：丢弃也没事，下次调度即可。</p>
<p>5）另外还要保证任务处理的幂等性，执行过的任务可以打上“已完成”的标记状态，下次再调度执行该任务判断任务状态确认是否已经完成。</p>
<p>我们在数据库视频处理表中添加处理状态的字段，视频处理完成更新状态为完成。下次执行该任务前先判断状态在决定是否执行该任务。</p>
<h3 id="8-3如何保证任务的幂等性"><a href="#8-3如何保证任务的幂等性" class="headerlink" title="8.3如何保证任务的幂等性"></a>8.3如何保证任务的幂等性</h3><p>幂等性：它描述了一次和多次请求某一个资源对于资源本身一个具有同样的结果。</p>
<p>幂等性是为了解决重复提交的问题，比如:恶意刷单，重复支付。</p>
<p>解决幂等性常用的方案：</p>
<p>1）数据库约束，比如：唯一索引，主键。同一个主键不可能两次插入成功。</p>
<p>2）唯一序列号,请求前生成唯一序列号，携带序列号去请求，执行时在redis记录该序列号，表示该序列号已经请求过了，如果请求携带的是redis中已经存有的序列号，说明该次请求是重复的。</p>
<p>3）乐观锁，常用于数据库，更新数据时根据乐观锁的状态去更新。</p>
<p>什么是乐观锁、悲观锁？synchronized是一种悲观锁，在执行被synchronized包裹的代码时需要首先获取锁，没有拿到锁则无法执行，是总悲观的认为别的线程会去抢，所以要悲观锁。乐观锁的思想是它不认为会有线程去争抢，尽管去执行，如果没有执行成功就再去重试。    </p>
<p>通常，它使用版本号或时间戳字段来检测并发修改，并确保在多个并发更新尝试中只有一个成功</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="keyword">UPDATE</span> media_process m</span><br><span class="line"><span class="keyword">SET</span> m.status<span class="operator">=</span><span class="string">&#x27;4&#x27;</span></span><br><span class="line"><span class="keyword">WHERE</span> (m.status<span class="operator">=</span><span class="string">&#x27;1&#x27;</span> <span class="keyword">OR</span> m.status<span class="operator">=</span><span class="string">&#x27;3&#x27;</span>)</span><br><span class="line"><span class="keyword">AND</span> m.fail_count <span class="operator">&lt;</span> <span class="number">3</span></span><br><span class="line"><span class="keyword">AND</span> m.id<span class="operator">=</span>?</span><br><span class="line"></span><br><span class="line"><span class="number">2</span><span class="keyword">UPDATE</span> media_process t</span><br><span class="line"><span class="keyword">SET</span> t.count <span class="operator">=</span> t.count <span class="operator">+</span> <span class="number">1</span>, t.version<span class="operator">=</span><span class="number">2</span></span><br><span class="line"><span class="keyword">WHERE</span> t.version <span class="operator">=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>1这个UPDATE语句将名为<code>media_process</code>的表中的记录的<code>status</code>字段设置为’4’，条件是当前<code>status</code>字段的值为’1’或’3’，<code>fail_count</code>字段的值小于3，且满足指定的<code>id</code>条件。这个操作将满足条件的记录的<code>status</code>字段更新为’4’，表示这些记录已经被处理。</p>
<p>2这个UPDATE语句将名为<code>media_process</code>的表中的记录的<code>count</code>字段递增1，同时将<code>version</code>字段更新为2，条件是当前<code>version</code>字段的值为1。这个操作通常用于对某些记录进行计数或标记，确保在并发情况下不会出现竞态条件</p>
<h2 id="9-分布式事务："><a href="#9-分布式事务：" class="headerlink" title="9.分布式事务："></a>9.分布式事务：</h2><h3 id="本地事务"><a href="#本地事务" class="headerlink" title="本地事务"></a>本地事务</h3><p>是在单一数据库或数据源上执行的事务操作，它具有ACID特性，适用于单一数据源的业务逻辑。</p>
<ol>
<li><strong>单一数据源</strong>：本地事务发生在单一的数据库或数据源上，所有的数据库操作都在同一个事务中进行。</li>
<li><strong>ACID特性</strong>：本地事务通常遵循ACID（原子性、一致性、隔离性和持久性）特性。这意味着事务要么完全成功，要么完全失败，并且在事务期间数据库保持一致性状态。</li>
<li><strong>事务管理</strong>：在本地事务中，通常需要事务管理器或编程框架（例如JDBC、Hibernate等）来管理事务的开始、提交、回滚和异常处理。</li>
<li><strong>锁定和隔离级别</strong>：本地事务中，可以使用锁定和隔离级别来控制并发访问数据库的方式，以确保事务的隔离性。</li>
<li><strong>性能和吞吐量</strong>：本地事务通常具有较高的性能和吞吐量，因为它们涉及的是单一数据源，没有涉及网络通信或多个系统之间的协调。</li>
<li><strong>适用性</strong>：本地事务适用于那些不需要跨多个数据源或数据库的业务逻辑，例如传统的单体应用程序。</li>
</ol>
<h3 id="分布式事务："><a href="#分布式事务：" class="headerlink" title="分布式事务："></a>分布式事务：</h3><p><img src="/img/fbs.png"></p>
<p>分布式事务是指涉及多个独立的数据源、系统或服务的事务操作。这些数据源、系统或服务可以位于不同的地理位置、运行在不同的计算机或容器中，可能使用不同的技术栈和编程语言。分布式事务的目标是确保在分布式环境下的多个操作能够以事务的方式一起成功或失败，以维护数据的一致性和可靠性。</p>
<ol>
<li><strong>多个参与者</strong>：分布式事务通常涉及多个事务参与者，每个参与者负责管理自己的数据源或系统。</li>
<li><strong>全局事务协调器</strong>：在分布式事务中，需要有一个全局事务协调器（也称为事务管理器或协调者），它负责协调各个参与者的事务操作，确保它们的状态一致。</li>
<li><strong>事务的隔离性</strong>：与本地事务一样，分布式事务也需要遵循ACID特性，包括事务的隔离性，以确保数据一致性。</li>
<li><strong>事务的提交和回滚</strong>：全局事务协调器负责决定是否提交或回滚整个分布式事务，这意味着所有参与者要么都提交成功，要么都回滚失败。</li>
<li><strong>两阶段提交（2PC）</strong>：2PC是一种常见的分布式事务协议，它包括两个阶段：准备阶段（协调者询问参与者是否可以提交事务）和提交阶段（如果准备阶段成功，则协调者通知所有参与者提交事务）。</li>
<li><strong>补偿事务</strong>：在分布式环境中，由于网络故障或参与者故障，可能会发生部分参与者已经提交而另一部分参与者未提交的情况。为了处理这种情况，可以使用补偿事务来回滚已经提交的部分。</li>
<li><strong>幂等性</strong>：为了确保分布式事务的幂等性，操作必须能够多次执行而不会产生不一致的结果。这对于处理重试和失败恢复非常重要。</li>
<li><strong>分布式事务模型</strong>：不同的分布式事务模型（例如XA事务、TCC事务、SAGA事务等）提供不同的机制和适用性，可以根据业务需求选择合适的模型。</li>
<li><strong>性能和复杂性权衡</strong>：分布式事务通常比本地事务更复杂，因为需要处理网络通信、故障恢复和协调多个参与者。因此，需要权衡性能和复杂性</li>
</ol>
<h3 id="CAP理论"><a href="#CAP理论" class="headerlink" title="CAP理论"></a>CAP理论</h3><p> CAP 定理，CAP 是 Consistency（一致性）、Availability（可用性）、Partition tolerance（分区容忍性）的缩写，</p>
<ol>
<li><strong>一致性（Consistency）</strong>：所有节点在同一时间点看到相同的数据视图。这意味着无论在哪个节点上进行读取操作，都应该获得最新的数据，并且写入操作应该立即反映在所有节点上。</li>
<li><strong>可用性（Availability）</strong>：每个请求都必须得到响应，无论它是否成功。即使系统的一部分节点故障，仍然需要继续提供服务。</li>
<li><strong>分区容忍性（Partition tolerance）</strong>：系统可以在网络分区或节点故障的情况下继续工作。分区容忍性意味着系统的某些部分无法与其他部分通信，但仍然可以继续运行。</li>
</ol>
<p>只能满足AP或CP</p>
<ol>
<li><p><strong>CP（一致性和分区容忍性）</strong>：如果系统选择了 CP，这意味着在面临网络分区时，系统会牺牲可用性以保持数据的一致性。这意味着系统可能在分区发生时停止接受新的请求，以确保数据的一致性。</p>
<p><em><strong>例如 ： 银行转账，开户操作</strong></em></p>
</li>
<li><p><strong>AP（可用性和分区容忍性）</strong>：如果系统选择了 AP，这意味着在面临网络分区时，系统会牺牲一致性以保持可用性。这意味着系统可能在分区发生时继续提供服务，但数据可能会处于不一致状态，直到分区恢复。</p>
</li>
</ol>
<p>​		<em><strong>例如：订单退款，注册送积分，支付短信通知</strong></em></p>
<h3 id="BASE理论："><a href="#BASE理论：" class="headerlink" title="BASE理论："></a>BASE理论：</h3><p>BASE 是一个分布式系统的理论模型，与 ACID（原子性、一致性、隔离性和持久性）相对立。</p>
<ol>
<li><strong>基本可用性（Basic Availability）</strong>：BASE 要求系统在面临故障或分区的情况下仍然能够保持基本的可用性。这意味着系统在一些部分或节点出现故障时，仍然可以继续提供有限的服务。</li>
<li><strong>软状态（Soft State）</strong>：BASE 接受系统在某一时刻的状态可能是不一致的，也就是说，在分布式系统中，一些数据的状态可能因为数据同步延迟或其他原因而有所不同。</li>
<li><strong>最终一致性（Eventually Consistency）</strong>：BASE 强调系统的一致性是最终达到的，而不需要实时保持一致。分布式系统可以在一段时间内处于不一致状态，但最终会收敛到一致状态。</li>
</ol>
<h3 id="分布式事务控制有哪些常用的方式："><a href="#分布式事务控制有哪些常用的方式：" class="headerlink" title="分布式事务控制有哪些常用的方式："></a>分布式事务控制有哪些常用的方式：</h3><ol>
<li><p><strong>实现CP - 一致性和分区容忍性</strong>：</p>
<p>a. <strong>Seata框架基于AT模式实现</strong>：</p>
<ul>
<li>Seata 是一个开源的分布式事务框架，支持多种事务模式，包括AT（原子性事务）。使用AT模式，Seata能够协调多个参与者，以实现分布式事务的一致性和分区容忍性。</li>
<li>AT模式基于两阶段提交（2PC）协议，确保在所有参与者上的操作要么全部提交成功，要么全部回滚失败。这可以实现强一致性。</li>
</ul>
<p>b. <strong>Seata框架基于TCC模式实现</strong>：</p>
<ul>
<li>除了AT模式，Seata还支持TCC（Try-Confirm-Cancel）模式，它通过预备、确认和取消三个阶段来实现分布式事务。TCC模式可以提供更大的灵活性和定制化，以满足特定的业务需求。</li>
</ul>
</li>
<li><p><strong>实现AP - 最终数据一致性</strong>：</p>
<p>a. <strong>使用消息队列通知的方式</strong>：</p>
<ul>
<li>在分布式系统中，可以使用消息队列来实现最终一致性。当需要跨多个数据存储或服务时，将数据更改的通知发布到消息队列，其他系统可以订阅这些通知并在本地进行处理。</li>
<li>为了实现可用性，可以配置消息队列以自动重试通知，直到达到最大失败次数。如果通知在一段时间内无法成功传递，可以进行人工处理。</li>
</ul>
<p>b. <strong>使用任务调度的方案</strong>：</p>
<ul>
<li>另一种实现最终一致性的方法是使用任务调度。例如，定期启动任务调度来将数据从一个数据库同步到其他数据存储或服务，以确保数据一致性。</li>
<li>这种方式通常需要开发者编写和管理同步任务，确保数据按计划同步。</li>
</ul>
</li>
</ol>
<p><img src="/img/fbs1.png"></p>
<p>本地消息表（mq_message表）+任务调度的机制</p>
<p><img src="/img/fbs2.png"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://tk666ttkk.github.io">tk</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://tk666ttkk.github.io/2023/09/09/mst/">https://tk666ttkk.github.io/2023/09/09/mst/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://tk666ttkk.github.io" target="_blank">Hxtk_blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/">面试题</a></div><div class="post_share"><div class="social-share" data-image="/img/mst.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.png" target="_blank"><img class="post-qr-code-img" src="/img/wechat.png" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.png" target="_blank"><img class="post-qr-code-img" src="/img/alipay.png" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/10/21/%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/" title="开发环境配置"><img class="cover" src="/img/kaifa.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">开发环境配置</div></div></a></div><div class="next-post pull-right"><a href="/2023/09/08/rk/" title="rk"><img class="cover" src="/img/rk.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">rk</div></div></a></div></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Hxtk</div><div class="author-info__description">blogger</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">8</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/tk666ttkk?tab=repositories"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/tk666ttkk?tab=repositories" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:1711660323@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">个人博客，仅供学习交流</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E9%A1%B9%E7%9B%AE%E7%9A%84%E9%9D%A2%E8%AF%95%E9%A2%98%EF%BC%9A"><span class="toc-text">学成在线项目的面试题：</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Maven%EF%BC%9A"><span class="toc-text">1.Maven：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1%E4%BE%9D%E8%B5%96%E7%89%88%E6%9C%AC%E5%86%B2%E7%AA%81%E6%80%8E%E4%B9%88%E5%A4%84%E7%90%86%EF%BC%9A"><span class="toc-text">1.1依赖版本冲突怎么处理：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Mysql"><span class="toc-text">2.Mysql</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1Mysql-%E5%B8%B8%E8%A7%81%E7%9A%84%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E5%92%8C%E5%8C%BA%E5%88%AB%EF%BC%9A"><span class="toc-text">2.1Mysql 常见的存储引擎和区别：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-InnoDB"><span class="toc-text">1.InnoDB</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-MyISAM"><span class="toc-text">2.MyISAM</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-memory"><span class="toc-text">3.memory</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E6%80%BB%E7%BB%93%EF%BC%9A"><span class="toc-text">4.总结：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2Mysql%E5%BB%BA%E8%A1%A8%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-text">2.2Mysql建表注意事项:</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E"><span class="toc-text">1.存储引擎</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%AD%97%E6%AE%B5%E7%B1%BB%E5%9E%8B%E9%80%89%E6%8B%A9"><span class="toc-text">2.字段类型选择</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%AD%97%E6%AE%B5"><span class="toc-text">3.字段</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3Mysql%E5%A6%82%E4%BD%95%E6%9F%A5%E8%AF%A2%E6%A0%91%E5%BD%A2%E8%A1%A8"><span class="toc-text">2.3Mysql如何查询树形表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-SpingBoot"><span class="toc-text">3.SpingBoot</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1springBoot%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E7%9A%84%E6%B3%A8%E8%A7%A3%E6%9C%89%E5%93%AA%E4%BA%9B%EF%BC%9A"><span class="toc-text">3.1springBoot接口开发常用的注解有哪些：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0%E7%9A%84%E5%90%88%E6%B3%95%E6%80%A7%E6%A0%A1%E9%AA%8C"><span class="toc-text">3.2请求参数的合法性校验</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1%E6%95%B0%E6%8D%AE%E7%9A%84%E6%A0%A1%E9%AA%8C"><span class="toc-text">3.2.1数据的校验</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E7%9A%84%E6%A0%A1%E9%AA%8C"><span class="toc-text">3.2.2业务逻辑的校验</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Mybatis"><span class="toc-text">4.Mybatis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1Mybatis%E5%88%86%E9%A1%B5%E6%8F%92%E4%BB%B6%E5%8E%9F%E7%90%86"><span class="toc-text">4.1Mybatis分页插件原理:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2Mybatis%E7%9A%84ResultType-%E5%92%8C-ResultMap%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-text">4.2Mybatis的ResultType 和 ResultMap的区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E5%92%8C-%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-text">4.3 #{} 和${} 的区别</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E7%B3%BB%E7%BB%9F%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-text">5.系统如何进行异常处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E4%BB%80%E4%B9%88%E6%83%85%E5%86%B5%E4%B8%8B%E4%BA%8B%E5%8A%A1%E5%9B%9E%E5%A4%B1%E6%95%88%EF%BC%9A"><span class="toc-text">6.什么情况下事务回失效：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%9C%A8%E6%96%B9%E6%B3%95%E4%B8%AD%E6%8D%95%E8%8E%B7%E5%BC%82%E5%B8%B8%E6%B2%A1%E6%9C%89%E6%8A%9B%E5%87%BA"><span class="toc-text">1)在方法中捕获异常没有抛出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%EF%BC%89%E9%9D%9E%E4%BA%8B%E5%8A%A1%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E4%BA%8B%E5%8A%A1%E6%96%B9%E6%B3%95"><span class="toc-text">2）非事务方法调用事务方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%EF%BC%89%E4%BA%8B%E5%8A%A1%E6%96%B9%E6%B3%95%E5%86%85%E9%83%A8%E8%B0%83%E7%94%A8%E4%BA%8B%E5%8A%A1%E6%96%B9%E6%B3%95"><span class="toc-text">3）事务方法内部调用事务方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Transactional%E6%A0%87%E8%AE%B0%E7%9A%84%E6%96%B9%E6%B3%95%E4%B8%8D%E6%98%AFpublic"><span class="toc-text">4)@Transactional标记的方法不是public</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E6%8A%9B%E5%87%BA%E7%9A%84%E5%BC%82%E5%B8%B8%E4%B8%8ErollbackFor%E6%8C%87%E5%AE%9A%E7%9A%84%E5%BC%82%E5%B8%B8%E4%B8%8D%E5%8C%B9%E9%85%8D"><span class="toc-text">5)抛出的异常与rollbackFor指定的异常不匹配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%EF%BC%89%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E4%B8%8D%E6%94%AF%E6%8C%81%E4%BA%8B%E5%8A%A1%E5%A4%84%E7%90%86"><span class="toc-text">6）数据库表不支持事务处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%EF%BC%89springboot%E7%9A%84%E4%BC%A0%E6%92%AD%E8%A1%8C%E4%B8%BA%E5%AF%BC%E8%87%B4%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%A4%B1%E6%95%88"><span class="toc-text">7）springboot的传播行为导致事务的失效</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8%EF%BC%89%E6%80%BB%E7%BB%93%EF%BC%9A%E5%8F%AA%E6%9C%89%E9%80%9A%E8%BF%87%E5%BD%93%E5%89%8D%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1%E8%B0%83%E7%94%A8%E7%9A%84%E6%96%B9%E6%B3%95%E6%89%8D%E8%83%BD%E6%AD%A3%E7%A1%AE%E8%BF%9B%E8%A1%8C%E4%BA%8B%E5%8A%A1%E6%8E%A7%E5%88%B6"><span class="toc-text">8）总结：只有通过当前代理对象调用的方法才能正确进行事务控制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0"><span class="toc-text">7.断点续传</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-xxl-job"><span class="toc-text">8.xxl -job</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1%E5%8E%9F%E7%90%86%EF%BC%9A"><span class="toc-text">8.1原理：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E4%BB%BB%E5%8A%A1%E4%B8%8D%E4%BC%9A%E9%87%8D%E5%A4%8D%E6%89%A7%E8%A1%8C"><span class="toc-text">8.2如何保证任务不会重复执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E4%BB%BB%E5%8A%A1%E7%9A%84%E5%B9%82%E7%AD%89%E6%80%A7"><span class="toc-text">8.3如何保证任务的幂等性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%EF%BC%9A"><span class="toc-text">9.分布式事务：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E4%BA%8B%E5%8A%A1"><span class="toc-text">本地事务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%EF%BC%9A"><span class="toc-text">分布式事务：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CAP%E7%90%86%E8%AE%BA"><span class="toc-text">CAP理论</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BASE%E7%90%86%E8%AE%BA%EF%BC%9A"><span class="toc-text">BASE理论：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%8E%A7%E5%88%B6%E6%9C%89%E5%93%AA%E4%BA%9B%E5%B8%B8%E7%94%A8%E7%9A%84%E6%96%B9%E5%BC%8F%EF%BC%9A"><span class="toc-text">分布式事务控制有哪些常用的方式：</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/10/21/Redis%E9%9B%86%E7%BE%A4/" title="Redis集群"><img src="/img/rediscluster.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis集群"/></a><div class="content"><a class="title" href="/2023/10/21/Redis%E9%9B%86%E7%BE%A4/" title="Redis集群">Redis集群</a><time datetime="2023-10-21T09:59:22.000Z" title="发表于 2023-10-21 17:59:22">2023-10-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/10/21/%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/" title="开发环境配置"><img src="/img/kaifa.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="开发环境配置"/></a><div class="content"><a class="title" href="/2023/10/21/%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/" title="开发环境配置">开发环境配置</a><time datetime="2023-10-21T09:57:30.000Z" title="发表于 2023-10-21 17:57:30">2023-10-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/09/mst/" title="面试题"><img src="/img/mst.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="面试题"/></a><div class="content"><a class="title" href="/2023/09/09/mst/" title="面试题">面试题</a><time datetime="2023-09-09T06:17:32.000Z" title="发表于 2023-09-09 14:17:32">2023-09-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/08/rk/" title="rk"><img src="/img/rk.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="rk"/></a><div class="content"><a class="title" href="/2023/09/08/rk/" title="rk">rk</a><time datetime="2023-09-08T10:49:38.000Z" title="发表于 2023-09-08 18:49:38">2023-09-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/08/redis/" title="Redis"><img src="/img/redis.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis"/></a><div class="content"><a class="title" href="/2023/09/08/redis/" title="Redis">Redis</a><time datetime="2023-09-08T10:49:38.000Z" title="发表于 2023-09-08 18:49:38">2023-09-08</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/mst.png')"><div id="footer-wrap"><div class="copyright">&copy;2023 By Hxtk</div><div class="footer_custom_text"><a href= https://cloud.tencent.com/product/ba ><img class="icp-icon" src= /img/icp.jpg><span>湘ICP备2023009473号</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>function getGiscusTheme (theme) {
  return theme === 'dark' ? 'dark' : 'light'
}

function loadGiscus () {
  const config = Object.assign({
    src: 'https://giscus.app/client.js',
    'data-repo': 'tk666ttkk/tk666ttkk.github.io',
    'data-repo-id': 'R_kgDOKPLOqw',
    'data-category-id': 'DIC_kwDOKPLOq84CZHfG',
    'data-mapping': 'pathname',
    'data-theme': getGiscusTheme(document.documentElement.getAttribute('data-theme')),
    'data-reactions-enabled': '1',
    crossorigin: 'anonymous',
    async: true
  },null)

  let ele = document.createElement('script')
  for (let key in config) {
    ele.setAttribute(key, config[key])
  }
  document.getElementById('giscus-wrap').insertAdjacentElement('afterbegin',ele)
}

function changeGiscusTheme (theme) {
  function sendMessage(message) {
    const iframe = document.querySelector('iframe.giscus-frame')
    if (!iframe) return
    iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app')
  }

  sendMessage({
    setConfig: {
      theme: getGiscusTheme(theme)
    }
  });
}

btf.addModeChange('giscus', changeGiscusTheme)

if ('Giscus' === 'Giscus' || !true) {
  if (true) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
  else loadGiscus()
} else {
  function loadOtherComment () {
    loadGiscus()
  }
}</script></div><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="true" data-text="复,临,泰,大壮,夬,乾,姤,遯,否,观,剥,坤" data-fontsize="15px" data-random="true" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><!-- hexo injector body_end start --><script data-pjax>
  function card_artitalk_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-shuo"><div class="card-content" style="height:auto;min-height:280px;"><div class="item-headline"><i class="fas fa-comments"></i><span><a href="/artitalk/" title="artitalk page link">碎碎念</a></span><a id="cardVisual" style="cursor:pointer;float:right" onclick="cardVisual()">编辑</a></div><div id="artitalk_main" style="width:100%;height:100%;padding:1px"></div></div></div>';
    console.log('已挂载card_artitalk');
    parent_div_git.insertAdjacentHTML("afterbegin",item_html);
    (()=>{
      const init = () => {
        new Artitalk(Object.assign({
          appId: 'OkB15hnqeT37KHfurnrEnXIW-MdYXbMMI',
          appKey: 'aljqMsJRItPGAnOMAw2H3I8b',
        }, {"serverURL":"https://OkB15hnq.api.lncldglobal.com","lang":"zh","pageSize":1,"color1":"#49b1f5","color2":"#00c4b6","atEmoji":{"Mafumafu1":"https://cdn.jsdelivr.net/gh/GamerNoTitle/ValineCDN@master/Mafumafu/199749454.png","Mafumafu2":"https://cdn.jsdelivr.net/gh/GamerNoTitle/ValineCDN@master/Mafumafu/199749455.png"}} ))
      }
      if (typeof Artitalk === 'function') {
        init()
      } else {
        getScript('https://npm.elemecdn.com/artitalk').then(init)
      }
    })()
    }
  var elist = '/artitalk/,/posts/'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    card_artitalk_injector_config();
  }
  else if (epage === cpage){
    card_artitalk_injector_config();
  }
  </script><script async src="https://npm.elemecdn.com/hexo-butterfly-artitalk-pro/lib/card_visual.js"></script><!-- hexo injector body_end end --></body></html>